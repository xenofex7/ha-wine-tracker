<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7/css/materialdesignicons.min.css">
<link rel="stylesheet" href="{{ ingress }}/static/style.css">
<title>Wine Tracker</title>
</head>
<body>

<header>
  <a class="nav-brand" href="{{ ingress }}/"><i class="mdi mdi-glass-wine"></i></a>
  <nav class="nav-links">
    <a class="nav-link active" href="{{ ingress }}/">{{ t.nav_cellar }}</a>
    <a class="nav-link" href="{{ ingress }}/stats">{{ t.stats_title }}</a>
  </nav>
  <div class="header-spacer"></div>
  <div class="search-wrap">
    <i class="mdi mdi-magnify search-icon"></i>
    <input type="text" id="searchInput" placeholder="{{ t.search_placeholder }}" autocomplete="off" oninput="debouncedFilter()">
    <button type="button" class="search-clear" onclick="clearSearch()">×</button>
  </div>
  {% if used_types|length > 0 %}
  <div class="filter-dropdown-wrap">
    <button class="filter-btn" onclick="toggleFilterDropdown()" title="Filter"><i class="mdi mdi-filter-variant"></i></button>
    <div class="filter-dropdown" id="filterDropdown">
      <div class="filter-list" id="filterTabs">
        <label class="filter-option active" data-type="">
          <input type="radio" name="wineType" value="" checked onchange="filterByType('')"> {{ t.filter_all }}
        </label>
        {% for wt in used_types %}
        <label class="filter-option" data-type="{{ wt }}">
          <input type="radio" name="wineType" value="{{ wt }}" onchange="filterByType('{{ wt }}')"> {{ wt | wine_type }}
        </label>
        {% endfor %}
      </div>
      <hr class="filter-divider">
      <label class="filter-option toggle-empty-option" id="toggleEmptyBtn" onclick="toggleEmpty()">
        {{ t.toggle_empty_show }}
      </label>
    </div>
  </div>
  {% endif %}
  <button class="theme-toggle" onclick="cycleTheme()" title="{{ t.toggle_theme }}"><span class="theme-icon"><i class="mdi mdi-laptop"></i></span></button>
</header>

<!-- Wine Grid -->
<div class="grid">
  {% if not wines %}
  <div class="empty-state" style="grid-column: 1/-1">
    <div><i class="mdi mdi-glass-wine"></i></div>
    <p>{{ t.empty_no_wines }}<br>{{ t.empty_add_first }}</p>
  </div>
  {% endif %}

  {% for w in wines %}
  <div class="card {% if w['quantity'] == 0 %}empty{% endif %}" data-id="{{ w['id'] }}"
       data-name="{{ w['name'] }}" data-year="{{ w['year'] or '' }}"
       data-type="{{ w['type'] or '' }}" data-region="{{ w['region'] or '' }}"
       data-quantity="{{ w['quantity'] }}" data-rating="{{ w['rating'] }}"
       data-notes="{{ w['notes'] or '' }}" data-image="{{ w['image'] or '' }}"
       data-purchased_at="{{ w['purchased_at'] or '' }}" data-price="{{ w['price'] or '' }}"
       data-drink_from="{{ w['drink_from'] or '' }}" data-drink_until="{{ w['drink_until'] or '' }}"
       data-location="{{ w['location'] or '' }}"
       data-grape="{{ w['grape'] or '' }}"
       data-vivino_id="{{ w['vivino_id'] or '' }}">

    {% if w['quantity'] == 0 %}
      <div class="ribbon ribbon-empty">{{ t.ribbon_empty }}</div>
    {% elif w['type'] %}
      <div class="ribbon ribbon-{{ w['type']|lower|replace('é','e')|replace('ö','oe') }}">{{ w['type'] | wine_type }}</div>
    {% endif %}

    <div class="card-img" onclick="cardImgClick(this)">
      {% if w['image'] %}
        <img src="{{ ingress }}/uploads/{{ w['image'] }}" alt="{{ w['name'] }}" loading="lazy">
      {% else %}
        <i class="mdi {{ 'mdi-glass-flute' if w['type'] == 'Schaumwein' else 'mdi-glass-wine' }}"></i>
      {% endif %}
    </div>

    <!-- Quantity badge -->
    <div class="qty-badge {% if w['quantity'] > 0 %}has{% endif %}">
      {{ w['quantity'] }} {{ t.bottles_abbr }}
    </div>

    <div class="card-body" onclick="editFromCard(this)">
      <div class="card-name" title="{{ w['name'] }}">{{ w['name'] }}</div>
      <div class="card-meta">
        {% if w['year'] %}<span>{{ w['year'] }}</span>{% endif %}
        {% if w['region'] %}<span>{{ w['region'] }}</span>{% endif %}
      </div>
      {% if w['rating'] %}
      <div class="stars">{% for i in range(w['rating']) %}<i class="mdi mdi-star"></i>{% endfor %}{% for i in range(5 - w['rating']) %}<i class="mdi mdi-star-outline"></i>{% endfor %}</div>
      {% endif %}
      <div class="card-extra">
        {% if w['price'] %}<span class="price">{{ currency }} {{ "%.2f"|format(w['price']) }}</span>{% endif %}
        {% if w['drink_from'] or w['drink_until'] %}<span class="drink-window"><i class="mdi mdi-calendar-range"></i> {{ w['drink_from'] or '?' }}–{{ w['drink_until'] or '?' }}</span>{% endif %}
        {% if w['grape'] %}<span><i class="mdi mdi-fruit-grapes"></i> {{ w['grape'] }}</span>{% endif %}
        {% if w['location'] %}<span><i class="mdi mdi-map-marker"></i> {{ w['location'] }}</span>{% endif %}
        {% if w['vivino_id'] %}<a class="card-vivino-link" href="https://www.vivino.com/w/{{ w['vivino_id'] }}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="Vivino"><i class="mdi mdi-open-in-new"></i> Vivino</a>{% endif %}
      </div>
      {% if w['notes'] %}
      <div class="card-notes">{{ w['notes'] }}</div>
      {% endif %}
    </div>

    <div class="card-actions">
      <button onclick="changeQty(this,-1)" title="{{ t.btn_less }}" style="padding:.5rem .65rem">−</button>
      <span class="qty-display" style="flex:1; display:flex; align-items:center; justify-content:center;
                   font-size:.85rem; color: var(--gold); font-weight:700;">
        {{ w['quantity'] }}
      </span>
      <button onclick="changeQty(this,1)" title="{{ t.btn_more }}" style="padding:.5rem .65rem">+</button>
      <button onclick="editFromCard(this)"
              title="{{ t.btn_edit }}" style="border-left:1px solid var(--border)"><i class="mdi mdi-pencil"></i></button>
      <button onclick="dupFromCard(this)"
              title="{{ t.btn_duplicate }}"><i class="mdi mdi-content-copy"></i></button>
      <button class="danger" title="{{ t.btn_delete }}"
              onclick="deleteFromCard(this)"><i class="mdi mdi-delete"></i></button>
    </div>
  </div>
  {% endfor %}
</div>


<!-- ═══════════════ WINE MODAL (Add + Edit) ═══════════════ -->
<div class="modal-overlay" id="wineModal">
  <div class="modal">
    <div class="modal-header">
      <span id="wineModalTitle">{{ t.modal_add_title }}</span>
      <button class="modal-close" onclick="tryCloseWineModal()">×</button>
    </div>
    <!-- Source Step: choose AI / Vivino / Manual -->
    <div id="sourceStep" class="source-step" style="display:none;">
      <div class="source-step-header">
        <h3>{{ t.source_step_title }}</h3>
        <p>{{ t.source_step_subtitle }}</p>
      </div>
      <div class="source-options">
        {% if ai_enabled %}
        <div class="source-option" onclick="onSourceAi()">
          <i class="mdi mdi-camera"></i>
          <div class="source-text">
            <div class="source-label">{{ t.ai_step_title }}</div>
            <div class="source-desc">{{ t.source_ai_desc }}</div>
          </div>
        </div>
        {% endif %}
        <div class="source-option" onclick="onSourceVivino()">
          <i class="mdi mdi-magnify"></i>
          <div class="source-text">
            <div class="source-label">{{ t.vivino_title }}</div>
            <div class="source-desc">{{ t.vivino_desc }}</div>
          </div>
        </div>
        <div class="source-option" onclick="skipToManual()">
          <i class="mdi mdi-pencil"></i>
          <div class="source-text">
            <div class="source-label">{{ t.ai_skip }}</div>
            <div class="source-desc">{{ t.manual_desc }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Panel (shown after clicking AI option) -->
    {% if ai_enabled %}
    <div id="aiStep" class="ai-step" style="display:none;">
      <h3>{{ t.ai_step_title }}</h3>
      <p>{{ t.ai_step_subtitle }}</p>

      <div class="ai-upload-area" id="aiUploadArea">
        <i class="mdi mdi-camera"></i>
        <span>{{ t.ai_upload_btn }}</span>
        <input type="file" accept="image/*" capture="environment" onchange="handleAiImage(this.files[0])">
      </div>

      <div class="ai-preview-wrap" id="aiPreviewWrap" style="display:none;">
        <img id="aiPreviewImg" src="" alt="">
      </div>

      <div class="ai-loading" id="aiLoading" style="display:none;">
        <div class="ai-spinner"></div>
        <span>{{ t.ai_analyzing }}</span>
      </div>

      <div id="aiError" style="display:none;">
        <div class="ai-error-msg">{{ t.ai_error }}</div>
        <div class="ai-btn-row">
          <button type="button" class="ai-btn" onclick="aiRetry()">{{ t.ai_retry }}</button>
          <button type="button" class="ai-btn" onclick="aiChangePhoto()">{{ t.ai_change_photo }}</button>
          <button type="button" class="ai-btn primary" onclick="skipToManual()">{{ t.ai_skip }}</button>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Vivino Panel (shown after clicking Vivino option) -->
    <div id="vivinoStep" class="vivino-panel" style="display:none;">
      <h3><i class="mdi mdi-magnify"></i> {{ t.vivino_title }}</h3>
      <p>{{ t.vivino_desc }}</p>
      <input type="text" class="vivino-search-input" id="vivinoSearchInput"
             placeholder="{{ t.vivino_placeholder }}" oninput="debouncedVivinoSearch()">
      <div id="vivinoStatus" class="vivino-status" style="display:none;"></div>
      <div id="vivinoResults" class="vivino-results"></div>
    </div>

    <form method="post" id="wineForm" enctype="multipart/form-data">
      <input type="hidden" name="ai_image" id="aiImageField" value="">
      <input type="hidden" name="vivino_id" id="wine_vivino_id" value="">
      <input type="hidden" name="delete_image" id="deleteImageField" value="">
      <div class="modal-body" id="formStep">

        <!-- Photo: shown inline on mobile, side panel on wide screens -->
        <div class="form-photo-panel">
          <label>{{ t.label_photo }}</label>
          <div class="img-preview" id="winePreview">
            <i class="mdi mdi-camera" style="font-size:2rem; opacity:.5"></i>
            <input type="file" name="image" accept="image/*"
                   onchange="previewImg(this,'winePreview')">
            <div class="img-actions" id="imgActions" style="display:none">
              <button type="button" class="img-action-btn" onclick="rotateWineImage()" title="Rotate"><i class="mdi mdi-rotate-right"></i></button>
              <button type="button" class="img-action-btn danger" onclick="deleteWineImage()" title="Delete"><i class="mdi mdi-delete"></i></button>
            </div>
          </div>
        </div>

        <div class="form-fields-panel">
        <div>
          <label>{{ t.label_name }}</label>
          <input type="text" name="name" id="wine_name" required placeholder="{{ t.placeholder_name }}">
        </div>

        <div class="row2">
          <div>
            <label>{{ t.label_vintage }}</label>
            <input type="number" name="year" id="wine_year" min="1900" max="2099" placeholder="2020">
          </div>
          <div>
            <label>{{ t.label_quantity }}</label>
            <input type="number" name="quantity" id="wine_qty" min="0" value="1">
          </div>
        </div>

        <div class="row2">
          <div>
            <label>{{ t.label_type }}</label>
            <select name="type" id="wine_type">
              <option value="">{{ t.type_select_default }}</option>
              {% for wt in wine_types %}
              <option value="{{ wt }}">{{ wt | wine_type }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>{{ t.label_region }}</label>
            <input type="text" name="region" id="wine_region" placeholder="{{ t.placeholder_region }}" list="regionList" autocomplete="off">
            <datalist id="regionList">
              {% for r in used_regions %}
              <option value="{{ r }}">
              {% endfor %}
            </datalist>
          </div>
        </div>

        <div>
          <label>{{ t.label_grape }}</label>
          <input type="text" name="grape" id="wine_grape" placeholder="{{ t.placeholder_grape }}" list="grapeList" autocomplete="off">
          <datalist id="grapeList">
            {% for g in used_grapes %}
            <option value="{{ g }}">
            {% endfor %}
          </datalist>
        </div>

        <div>
          <label>{{ t.label_rating }}</label>
          <div class="star-input">
            {% for i in [5,4,3,2,1] %}
            <input type="radio" name="rating" id="wine_star{{ i }}" value="{{ i }}">
            <label for="wine_star{{ i }}"><i class="mdi mdi-star"></i></label>
            {% endfor %}
          </div>
        </div>

        <div class="row2">
          <div>
            <label>{{ t.label_purchased_at }}</label>
            <input type="text" name="purchased_at" id="wine_purchased_at" placeholder="{{ t.placeholder_purchased }}" list="purchasedAtList" autocomplete="off">
            <datalist id="purchasedAtList">
              {% for p in used_purchased_at %}
              <option value="{{ p }}">
              {% endfor %}
            </datalist>
          </div>
          <div>
            <label>{{ t.label_price }} ({{ currency }})</label>
            <input type="number" name="price" id="wine_price" min="0" step="0.01" placeholder="54.90">
          </div>
        </div>

        <div class="row2">
          <div>
            <label>{{ t.label_drink_from }}</label>
            <input type="number" name="drink_from" id="wine_drink_from" min="2000" max="2099" placeholder="2025">
          </div>
          <div>
            <label>{{ t.label_drink_until }}</label>
            <input type="number" name="drink_until" id="wine_drink_until" min="2000" max="2099" placeholder="2030">
          </div>
        </div>

        <div>
          <label>{{ t.label_location }}</label>
          <input type="text" name="location" id="wine_location" placeholder="{{ t.placeholder_location }}" list="locationList" autocomplete="off">
          <datalist id="locationList">
            {% for loc in used_locations %}
            <option value="{{ loc }}">
            {% endfor %}
          </datalist>
        </div>

        <div>
          <label>{{ t.label_notes }}</label>
          <textarea name="notes" id="wine_notes" placeholder="{{ t.placeholder_notes }}"></textarea>
        </div>

        <div class="form-footer" id="formFooter">
          <div class="reload-popover-wrap" id="reloadPopoverWrap" style="display:none">
            <button type="button" class="btn-reload-trigger" id="reloadTriggerBtn" onclick="toggleReloadPopover()" title="{{ t.btn_reload }}">
              <i class="mdi mdi-refresh"></i>
            </button>
            <div class="reload-popover" id="reloadPopover" style="display:none">
              {% if ai_enabled %}
              <button type="button" class="reload-popover-option" onclick="reloadViaAi(); closeReloadPopover();">
                <i class="mdi mdi-robot"></i> {{ t.reload_ai_desc }}
              </button>
              {% endif %}
              <button type="button" class="reload-popover-option" onclick="reloadViaVivino(); closeReloadPopover();">
                <i class="mdi mdi-web"></i> {{ t.reload_vivino_desc }}
              </button>
            </div>
          </div>
          <button type="submit" class="btn-submit" id="wineSubmitBtn">{{ t.btn_save }}</button>
        </div>
        </div><!-- /form-fields-panel -->
      </div>
    </form>
  </div>
</div>


<!-- ═══════════════ DUPLICATE MODAL ═══════════════ -->
<div class="modal-overlay" id="dupModal">
  <div class="modal">
    <div class="modal-header">
      {{ t.dup_title }}
      <button class="modal-close" onclick="closeModal('dupModal')">×</button>
    </div>
    <form method="post" id="dupForm">
      <div class="modal-body">
        <div class="dup-hint" id="dupHint"></div>

        <div class="row2">
          <div>
            <label>{{ t.dup_new_vintage }}</label>
            <input type="number" name="new_year" id="dup_year" min="1900" max="2099">
          </div>
          <div>
            <label>{{ t.dup_qty }}</label>
            <input type="number" name="quantity" id="dup_qty" min="0" value="1">
          </div>
        </div>

        <p style="font-size:.8rem; color: var(--muted)">
          {{ t.dup_hint }}
        </p>

        <button type="submit" class="btn-submit">{{ t.btn_create_dup }}</button>
      </div>
    </form>
  </div>
</div>


<!-- ═══════════════ DELETE CONFIRM MODAL ═══════════════ -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="max-width:360px">
    <div class="modal-header">
      {{ t.delete_title }}
      <button class="modal-close" onclick="closeModal('deleteModal')">×</button>
    </div>
    <div class="delete-confirm-body">
      <div class="delete-confirm-icon"><i class="mdi mdi-glass-wine"></i></div>
      <div class="delete-confirm-msg">
        <span class="delete-confirm-name" id="deleteWineName"></span> {{ t.delete_really }}
      </div>
    </div>
    <div class="delete-confirm-actions">
      <button class="btn-cancel" onclick="closeModal('deleteModal')">{{ t.btn_cancel }}</button>
      <form method="post" id="deleteForm" style="flex:1; display:contents">
        <button type="submit" class="btn-delete">{{ t.btn_confirm_delete }}</button>
      </form>
    </div>
  </div>
</div>


<!-- ═══════════════ LIGHTBOX ═══════════════ -->
<div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
  <img id="lightboxImg" src="" alt="{{ t.lightbox_alt }}">
</div>

<script>
const INGRESS = '{{ ingress }}';
const CURRENCY = '{{ currency }}';
const T = {{ t | tojson }};

// Theme: 3-state cycle → system → dark → light
const THEME_MODES = ['system', 'dark', 'light'];
const THEME_ICONS = { dark: '<i class="mdi mdi-weather-night"></i>', light: '<i class="mdi mdi-weather-sunny"></i>', system: '<i class="mdi mdi-laptop"></i>' };

function getSystemPreference() {
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}

function applyTheme(mode) {
  const effective = mode === 'system' ? getSystemPreference() : mode;
  document.documentElement.classList.toggle('light', effective === 'light');
  const btn = document.querySelector('.theme-icon');
  if (btn) btn.innerHTML = THEME_ICONS[mode];
}

function cycleTheme() {
  const current = localStorage.getItem('wine-theme') || 'system';
  const idx = THEME_MODES.indexOf(current);
  const next = THEME_MODES[(idx + 1) % THEME_MODES.length];
  localStorage.setItem('wine-theme', next);
  applyTheme(next);
}

// Init theme
(function() {
  const saved = localStorage.getItem('wine-theme') || 'system';
  applyTheme(saved);
  // Listen for OS theme changes when in system mode
  window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
    if ((localStorage.getItem('wine-theme') || 'system') === 'system') applyTheme('system');
  });
})();

// ── Client-side filter state ─────────────────────────────────────────────────
var activeType = '';
var showEmpty = false;
var _filterTimer = null;

function debouncedFilter() {
  clearTimeout(_filterTimer);
  _filterTimer = setTimeout(applyFilters, 150);
}

function applyFilters() {
  var query = document.getElementById('searchInput').value.trim().toLowerCase();
  var cards = document.querySelectorAll('.grid .card');
  var visibleCount = 0;

  cards.forEach(function(card) {
    var d = card.dataset;
    // Type match
    var typeOk = !activeType || d.type === activeType;
    // Search match (name, region, notes)
    var searchOk = !query ||
      (d.name || '').toLowerCase().indexOf(query) !== -1 ||
      (d.region || '').toLowerCase().indexOf(query) !== -1 ||
      (d.notes || '').toLowerCase().indexOf(query) !== -1;
    // Empty match
    var emptyOk = showEmpty || parseInt(d.quantity) > 0;

    var visible = typeOk && searchOk && emptyOk;
    card.style.display = visible ? '' : 'none';
    if (visible) visibleCount++;
  });

  // Show/hide empty state
  var grid = document.querySelector('.grid');
  var emptyState = grid.querySelector('.empty-state');
  if (visibleCount === 0 && cards.length > 0) {
    if (!emptyState) {
      emptyState = document.createElement('div');
      emptyState.className = 'empty-state';
      emptyState.style.gridColumn = '1/-1';
      emptyState.innerHTML = '<div><i class="mdi mdi-magnify" style="font-size:4rem"></i></div><p>' + T.empty_no_results + '</p>';
      grid.appendChild(emptyState);
    }
    emptyState.style.display = '';
  } else if (emptyState && cards.length > 0) {
    emptyState.style.display = 'none';
  }

  // Update search-clear button visibility
  var clearBtn = document.querySelector('.search-clear');
  if (clearBtn) clearBtn.style.display = query ? 'block' : '';

  // Update tab counts
  updateTabCounts();
}

function updateTabCounts() {
  var opts = document.querySelectorAll('#filterTabs .filter-option');
  if (!opts.length) return;
  var cards = document.querySelectorAll('.grid .card');
  var query = document.getElementById('searchInput').value.trim().toLowerCase();

  // Count cards per type (respecting search + empty filter, ignoring type filter)
  var counts = {};
  var total = 0;
  cards.forEach(function(card) {
    var d = card.dataset;
    var searchOk = !query ||
      (d.name || '').toLowerCase().indexOf(query) !== -1 ||
      (d.region || '').toLowerCase().indexOf(query) !== -1 ||
      (d.notes || '').toLowerCase().indexOf(query) !== -1;
    var emptyOk = showEmpty || parseInt(d.quantity) > 0;
    if (searchOk && emptyOk) {
      total++;
      var t = d.type || '';
      counts[t] = (counts[t] || 0) + 1;
    }
  });

  opts.forEach(function(opt) {
    if (opt.classList.contains('toggle-empty-option')) return; // skip empty-toggle
    var type = opt.dataset.type !== undefined ? opt.dataset.type : '';
    var radio = opt.querySelector('input[type="radio"]');
    var label = opt.dataset.label || opt.textContent.replace(/\s*\(\d+\)\s*$/, '').trim();
    if (!opt.dataset.label) opt.dataset.label = label;
    var count = type === '' ? total : (counts[type] || 0);
    // Preserve the radio input, update only the text
    if (radio) {
      opt.textContent = '';
      opt.appendChild(radio);
      opt.appendChild(document.createTextNode(' ' + label + ' (' + count + ')'));
    }
  });
}

function filterByType(type) {
  activeType = type;
  // Update active states
  var opts = document.querySelectorAll('#filterTabs .filter-option');
  opts.forEach(function(opt) {
    var optType = opt.dataset.type !== undefined ? opt.dataset.type : '';
    opt.classList.toggle('active', optType === activeType);
  });
  applyFilters();
}

function toggleEmpty() {
  showEmpty = !showEmpty;
  var btn = document.getElementById('toggleEmptyBtn');
  btn.textContent = showEmpty ? T.toggle_empty_hide : T.toggle_empty_show;
  applyFilters();
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  applyFilters();
}

function toggleFilterDropdown() {
  var dd = document.getElementById('filterDropdown');
  if (dd) dd.classList.toggle('open');
}
document.addEventListener('click', function(e) {
  var wrap = document.querySelector('.filter-dropdown-wrap');
  if (wrap && !wrap.contains(e.target)) {
    var dd = document.getElementById('filterDropdown');
    if (dd) dd.classList.remove('open');
  }
});

function ensureFilterTab(type) {
  if (!type) return;
  var list = document.getElementById('filterTabs');
  if (!list) return; // filter dropdown not rendered (no wines yet)
  // Check if option for this type already exists
  var existing = list.querySelectorAll('.filter-option');
  for (var i = 0; i < existing.length; i++) {
    if (existing[i].dataset.type === type) return;
  }
  var lbl = document.createElement('label');
  lbl.className = 'filter-option';
  lbl.dataset.type = type;
  var radio = document.createElement('input');
  radio.type = 'radio';
  radio.name = 'wineType';
  radio.value = type;
  radio.onchange = function() { filterByType(type); };
  lbl.appendChild(radio);
  lbl.appendChild(document.createTextNode(' ' + (T['wine_type_' + type] || type)));
  list.appendChild(lbl);
}

function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// Close on overlay click (wineModal: block if dirty)
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => {
    if (e.target !== el) return;
    if (el.id === 'wineModal') {
      if (isWineFormDirty()) return; // block close
    }
    el.classList.remove('open');
  });
});

// ESC closes modals & lightbox (wineModal: guard if dirty)
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeLightbox();
    document.querySelectorAll('.modal-overlay.open').forEach(el => {
      if (el.id === 'wineModal') {
        tryCloseWineModal();
      } else {
        el.classList.remove('open');
      }
    });
  }
});

function previewImg(input, previewId) {
  const preview = document.getElementById(previewId);
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    let img = preview.querySelector('img');
    if (!img) { img = document.createElement('img'); preview.prepend(img); }
    img.src = e.target.result;
    preview.childNodes.forEach(n => { if (n.nodeType === 3) n.remove(); });
    let cam = preview.querySelector('.mdi-camera'); if (cam) cam.style.display = 'none';
    var actions = document.getElementById('imgActions');
    if (actions) actions.style.display = '';
  };
  reader.readAsDataURL(file);
}

var _editWineId = null;

function rotateWineImage() {
  var preview = document.getElementById('winePreview');
  var img = preview.querySelector('img');
  if (!img) return;
  var tempImg = new Image();
  tempImg.crossOrigin = 'anonymous';
  tempImg.onload = function() {
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    canvas.width = tempImg.naturalHeight;
    canvas.height = tempImg.naturalWidth;
    ctx.translate(canvas.width, 0);
    ctx.rotate(Math.PI / 2);
    ctx.drawImage(tempImg, 0, 0);
    img.src = canvas.toDataURL('image/jpeg', 0.85);
    canvas.toBlob(function(blob) {
      var file = new File([blob], 'rotated.jpg', { type: 'image/jpeg' });
      var dt = new DataTransfer();
      dt.items.add(file);
      preview.querySelector('input[type=file]').files = dt.files;
    }, 'image/jpeg', 0.85);
  };
  tempImg.src = img.src;
}

function deleteWineImage() {
  if (!confirm('Delete photo?')) return;
  document.getElementById('deleteImageField').value = '1';
  var preview = document.getElementById('winePreview');
  var img = preview.querySelector('img');
  if (img) img.remove();
  // Restore camera icon
  var cam = preview.querySelector('.mdi-camera');
  if (cam) { cam.style.display = ''; }
  else {
    cam = document.createElement('i');
    cam.className = 'mdi mdi-camera';
    cam.style.cssText = 'font-size:2rem; opacity:.5';
    preview.insertBefore(cam, preview.firstChild);
  }
  document.getElementById('imgActions').style.display = 'none';
}

const AI_ENABLED = {{ 'true' if ai_enabled else 'false' }};
var _aiLastFile = null; // track file for retry
var _reloadMode = false; // true = filling only empty fields in edit mode

// Store original placeholders so we can hide them in edit mode
var _placeholders = {};
['wine_name','wine_year','wine_region','wine_grape','wine_purchased_at',
 'wine_price','wine_drink_from','wine_drink_until','wine_location','wine_notes'].forEach(function(id) {
  var el = document.getElementById(id);
  if (el) _placeholders[id] = el.placeholder || '';
});

function openWineModal(id, wine) {
  _reloadMode = false;
  const isEdit = !!id;
  const form = document.getElementById('wineForm');
  const preview = document.getElementById('winePreview');

  // Title & button text
  document.getElementById('wineModalTitle').textContent = isEdit ? T.modal_edit_title : T.modal_add_title;
  document.getElementById('wineSubmitBtn').textContent = isEdit ? T.btn_save_changes : T.btn_save;

  // Form action
  form.action = isEdit ? INGRESS + '/edit/' + id : INGRESS + '/add';

  // Reset file input & hidden fields
  const fileInput = preview.querySelector('input[type=file]');
  if (fileInput) fileInput.value = '';
  document.getElementById('aiImageField').value = '';
  document.getElementById('deleteImageField').value = '';
  _editWineId = isEdit ? id : null;

  // Fill fields (empty for add, data for edit)
  const w = wine || {};
  document.getElementById('wine_name').value = w.name || '';
  document.getElementById('wine_year').value = w.year || '';
  document.getElementById('wine_qty').value = w.quantity !== undefined ? w.quantity : 1;
  document.getElementById('wine_type').value = w.type || '';
  document.getElementById('wine_region').value = w.region || '';
  document.getElementById('wine_notes').value = w.notes || '';
  document.getElementById('wine_purchased_at').value = w.purchased_at || '';
  document.getElementById('wine_price').value = w.price || '';
  document.getElementById('wine_drink_from').value = w.drink_from || '';
  document.getElementById('wine_drink_until').value = w.drink_until || '';
  document.getElementById('wine_location').value = w.location || '';
  document.getElementById('wine_grape').value = w.grape || '';
  document.getElementById('wine_vivino_id').value = w.vivino_id || '';

  // Stars
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('wine_star' + i);
    if (el) el.checked = isEdit ? (w.rating == i) : false;
  }

  // Placeholders: show in add mode, hide in edit mode
  Object.keys(_placeholders).forEach(function(pid) {
    var el = document.getElementById(pid);
    if (el) el.placeholder = isEdit ? '' : _placeholders[pid];
  });

  // Image preview
  var imgActions = document.getElementById('imgActions');
  let img = preview.querySelector('img');
  if (isEdit && w.image) {
    if (!img) { img = document.createElement('img'); preview.prepend(img); }
    img.src = INGRESS + '/uploads/' + w.image;
    preview.childNodes.forEach(n => { if (n.nodeType === 3) n.textContent = ''; });
    let camIcon = preview.querySelector('.mdi-camera');
    if (camIcon) camIcon.style.display = 'none';
    if (imgActions) imgActions.style.display = '';
  } else {
    if (img) img.remove();
    let hasIcon = preview.querySelector('.mdi-camera');
    if (!hasIcon) {
      const cam = document.createElement('i');
      cam.className = 'mdi mdi-camera';
      cam.style.cssText = 'font-size:2rem; opacity:.5';
      preview.insertBefore(cam, preview.firstChild);
    } else { hasIcon.style.display = ''; }
    if (imgActions) imgActions.style.display = 'none';
  }

  // Show/hide reload button (only in edit mode)
  var reloadWrap = document.getElementById('reloadPopoverWrap');
  if (reloadWrap) reloadWrap.style.display = isEdit ? '' : 'none';
  closeReloadPopover();

  // Source step: show source selection for add mode (not edit)
  if (!isEdit) {
    showSourceStep();
  } else {
    showFormStep();
  }

  openModal('wineModal');

  // Snapshot form state for dirty-tracking (after a tick so DOM settles)
  setTimeout(function() { wineFormSnapshot = getWineFormState(); }, 0);
}

// ── Source / AI / Vivino Step Functions ──────────────────────────────────────

function showSourceStep() {
  var sourceStep = document.getElementById('sourceStep');
  var aiStep = document.getElementById('aiStep');
  var vivinoStep = document.getElementById('vivinoStep');
  var formStep = document.getElementById('formStep');
  document.getElementById('wineModal').classList.remove('form-active');
  if (sourceStep) {
    sourceStep.style.display = '';
    // Reset titles to default (in case they were overridden by reload mode)
    var h3 = sourceStep.querySelector('.source-step-header h3');
    var p = sourceStep.querySelector('.source-step-header p');
    if (h3) h3.textContent = T.source_step_title;
    if (p) p.textContent = T.source_step_subtitle;
    // Reset descriptions
    var opts = sourceStep.querySelectorAll('.source-option');
    opts.forEach(function(opt) {
      var desc = opt.querySelector('.source-desc');
      var icon = opt.querySelector('.mdi');
      if (icon && icon.classList.contains('mdi-camera') && desc) desc.textContent = T.source_ai_desc;
      if (icon && icon.classList.contains('mdi-magnify') && desc) desc.textContent = T.vivino_desc;
      if (icon && icon.classList.contains('mdi-pencil') && desc) desc.textContent = T.manual_desc;
    });
  }
  if (aiStep) aiStep.style.display = 'none';
  if (vivinoStep) vivinoStep.style.display = 'none';
  if (formStep) formStep.style.display = 'none';
  var submitBtn = document.getElementById('wineSubmitBtn');
  if (submitBtn) submitBtn.style.display = 'none';
}

function onSourceAi() {
  if (_reloadMode) { reloadViaAi(); } else { showAiPanel(); }
}

function onSourceVivino() {
  if (_reloadMode) { reloadViaVivino(); } else { showVivinoPanel(); }
}

function showAiPanel() {
  var sourceStep = document.getElementById('sourceStep');
  var aiStep = document.getElementById('aiStep');
  var vivinoStep = document.getElementById('vivinoStep');
  var formStep = document.getElementById('formStep');
  if (sourceStep) sourceStep.style.display = 'none';
  if (vivinoStep) vivinoStep.style.display = 'none';
  if (formStep) formStep.style.display = 'none';
  if (aiStep) {
    aiStep.style.display = '';
    // Reset AI step to upload state
    document.getElementById('aiUploadArea').style.display = '';
    document.getElementById('aiPreviewWrap').style.display = 'none';
    document.getElementById('aiLoading').style.display = 'none';
    document.getElementById('aiError').style.display = 'none';
    var aiFileInput = aiStep.querySelector('input[type=file]');
    if (aiFileInput) aiFileInput.value = '';
    _aiLastFile = null;
  }
  var submitBtn = document.getElementById('wineSubmitBtn');
  if (submitBtn) submitBtn.style.display = 'none';
}

function showVivinoPanel() {
  var sourceStep = document.getElementById('sourceStep');
  var aiStep = document.getElementById('aiStep');
  var vivinoStep = document.getElementById('vivinoStep');
  var formStep = document.getElementById('formStep');
  if (sourceStep) sourceStep.style.display = 'none';
  if (aiStep) aiStep.style.display = 'none';
  if (formStep) formStep.style.display = 'none';
  if (vivinoStep) {
    vivinoStep.style.display = '';
    // Reset Vivino state
    var input = document.getElementById('vivinoSearchInput');
    if (input) { input.value = ''; input.focus(); }
    var results = document.getElementById('vivinoResults');
    if (results) results.innerHTML = '';
    var status = document.getElementById('vivinoStatus');
    if (status) { status.style.display = 'none'; status.textContent = ''; status.className = 'vivino-status'; }
  }
  var submitBtn = document.getElementById('wineSubmitBtn');
  if (submitBtn) submitBtn.style.display = 'none';
}

function showFormStep() {
  var sourceStep = document.getElementById('sourceStep');
  var aiStep = document.getElementById('aiStep');
  var vivinoStep = document.getElementById('vivinoStep');
  var formStep = document.getElementById('formStep');
  document.getElementById('wineModal').classList.add('form-active');
  if (sourceStep) sourceStep.style.display = 'none';
  if (aiStep) aiStep.style.display = 'none';
  if (vivinoStep) vivinoStep.style.display = 'none';
  if (formStep) formStep.style.display = '';
  var submitBtn = document.getElementById('wineSubmitBtn');
  if (submitBtn) submitBtn.style.display = '';
}

function skipToManual() {
  // Clear vivino_id when skipping to manual entry (not in reload mode)
  if (!_reloadMode) document.getElementById('wine_vivino_id').value = '';
  showFormStep();
}

// ── Vivino Search Functions ─────────────────────────────────────────────────

var _vivinoTimer = null;
var _vivinoAbort = null;
var _vivinoResults = [];

function debouncedVivinoSearch() {
  if (_vivinoTimer) clearTimeout(_vivinoTimer);
  var q = (document.getElementById('vivinoSearchInput').value || '').trim();
  if (q.length < 2) {
    document.getElementById('vivinoResults').innerHTML = '';
    var status = document.getElementById('vivinoStatus');
    if (status) { status.style.display = 'none'; status.className = 'vivino-status'; }
    return;
  }
  _vivinoTimer = setTimeout(function() { vivinoSearch(q); }, 400);
}

function vivinoSearch(query) {
  // Cancel any pending request
  if (_vivinoAbort) _vivinoAbort.abort();
  _vivinoAbort = new AbortController();

  // Show searching status
  var status = document.getElementById('vivinoStatus');
  var results = document.getElementById('vivinoResults');
  status.textContent = T.vivino_searching || 'Searching…';
  status.className = 'vivino-status';
  status.style.display = '';
  results.innerHTML = '';

  fetch(INGRESS + '/api/vivino-search?q=' + encodeURIComponent(query), {
    signal: _vivinoAbort.signal,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    status.style.display = 'none';
    if (data.ok && data.results && data.results.length > 0) {
      _vivinoResults = data.results;
      renderVivinoResults(data.results);
    } else if (data.ok) {
      _vivinoResults = [];
      status.textContent = T.vivino_no_results || 'No results found';
      status.className = 'vivino-status';
      status.style.display = '';
    } else {
      _vivinoResults = [];
      status.textContent = T.vivino_error || 'Search failed';
      status.className = 'vivino-status error';
      status.style.display = '';
    }
  })
  .catch(function(err) {
    if (err.name === 'AbortError') return; // cancelled, ignore
    _vivinoResults = [];
    status.textContent = T.vivino_error || 'Search failed';
    status.className = 'vivino-status error';
    status.style.display = '';
    results.innerHTML = '';
  });
}

function renderVivinoResults(items) {
  var container = document.getElementById('vivinoResults');
  container.innerHTML = items.map(function(item, idx) {
    var meta = [];
    if (item.year) meta.push(item.year);
    if (item.wine_type) meta.push(T['wine_type_' + item.wine_type] || item.wine_type);
    if (item.region) meta.push(item.region);

    var ratingHtml = '';
    if (item.rating) {
      ratingHtml = '<span class="vivino-result-rating"><i class="mdi mdi-star"></i> ' +
        Number(item.rating).toFixed(1) + '</span>';
    }

    var imgHtml = item.image_url
      ? '<img class="vivino-result-img" src="' + item.image_url + '" alt="" loading="lazy">'
      : '<div class="vivino-result-img" style="display:flex;align-items:center;justify-content:center;background:var(--surface2);"><i class="mdi mdi-glass-wine" style="font-size:1.5rem;opacity:.4"></i></div>';

    return '<div class="vivino-result-item" onclick="selectVivinoResult(' + idx + ')">' +
      imgHtml +
      '<div class="vivino-result-info">' +
        '<div class="vivino-result-name">' + (item.name || '').replace(/</g, '&lt;') + '</div>' +
        '<div class="vivino-result-meta">' + meta.join(' · ') + '</div>' +
        ratingHtml +
      '</div>' +
    '</div>';
  }).join('');
}

function selectVivinoResult(index) {
  var item = _vivinoResults[index];
  if (!item) return;

  // Map Vivino data to AI field format for reuse
  var fields = {};
  if (item.name) fields.name = item.name;
  if (item.year) fields.vintage = item.year;
  if (item.wine_type) fields.wine_type = item.wine_type;
  if (item.region) fields.region = item.region;
  if (item.grape) fields.grape = item.grape;
  if (item.price) fields.price = item.price;
  if (item.rating) fields.rating = item.rating;

  // Set vivino_id
  document.getElementById('wine_vivino_id').value = item.vivino_id || '';

  // Populate form (reuse AI function, pass null for image)
  populateFormFromAi(fields, null);

  // Set star rating if available (populateFormFromAi doesn't handle this)
  if (item.rating) {
    var starVal = Math.round(item.rating);
    if (starVal >= 1 && starVal <= 5) {
      var starEl = document.getElementById('wine_star' + starVal);
      if (starEl) starEl.checked = true;
    }
  }

  // Download Vivino image in the background
  if (item.image_url) {
    downloadVivinoImage(item.image_url);
  }
}

function downloadVivinoImage(url) {
  fetch(INGRESS + '/api/vivino-image', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ url: url })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.ok && data.filename) {
      // Set the image hidden field
      document.getElementById('aiImageField').value = data.filename;
      // Show the image in the form preview
      var preview = document.getElementById('winePreview');
      var img = preview.querySelector('img');
      if (!img) { img = document.createElement('img'); preview.prepend(img); }
      img.src = INGRESS + '/uploads/' + data.filename;
      // Hide camera icon
      var cam = preview.querySelector('.mdi-camera');
      if (cam) cam.style.display = 'none';
    }
  })
  .catch(function() { /* image download is best-effort */ });
}

function handleAiImage(file) {
  if (!file) return;
  _aiLastFile = file;

  // Show preview
  var reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('aiPreviewImg').src = e.target.result;
    document.getElementById('aiPreviewWrap').style.display = '';
    document.getElementById('aiUploadArea').style.display = 'none';
  };
  reader.readAsDataURL(file);

  // Start analysis
  startAiAnalysis(file);
}

function startAiAnalysis(file) {
  // Show loading, hide error
  document.getElementById('aiLoading').style.display = '';
  document.getElementById('aiError').style.display = 'none';

  var fd = new FormData();
  fd.append('image', file);

  fetch(INGRESS + '/api/analyze-wine', {
    method: 'POST',
    body: fd,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    document.getElementById('aiLoading').style.display = 'none';

    if (data.ok) {
      populateFormFromAi(data.fields, data.image_filename);
    } else {
      // Even on error, save the image filename if returned
      if (data.image_filename) {
        document.getElementById('aiImageField').value = data.image_filename;
      }
      document.getElementById('aiError').style.display = '';
    }
  })
  .catch(function() {
    document.getElementById('aiLoading').style.display = 'none';
    document.getElementById('aiError').style.display = '';
  });
}

function populateFormFromAi(fields, imageFilename) {
  // In reload mode, merge instead of overwrite
  if (_reloadMode) { populateFormMerge(fields, imageFilename); return; }
  // Set form fields from AI response
  if (fields.name) document.getElementById('wine_name').value = fields.name;
  if (fields.vintage) document.getElementById('wine_year').value = fields.vintage;
  if (fields.wine_type) document.getElementById('wine_type').value = fields.wine_type;
  if (fields.region) document.getElementById('wine_region').value = fields.region;
  if (fields.grape) document.getElementById('wine_grape').value = fields.grape;
  if (fields.price) document.getElementById('wine_price').value = fields.price;
  if (fields.drink_from) document.getElementById('wine_drink_from').value = fields.drink_from;
  if (fields.drink_until) document.getElementById('wine_drink_until').value = fields.drink_until;
  if (fields.notes) document.getElementById('wine_notes').value = fields.notes;

  // Set the AI image hidden field
  if (imageFilename) {
    document.getElementById('aiImageField').value = imageFilename;

    // Show the image in the form's preview area
    var preview = document.getElementById('winePreview');
    var img = preview.querySelector('img');
    if (!img) { img = document.createElement('img'); preview.prepend(img); }
    img.src = INGRESS + '/uploads/' + imageFilename;
    // Hide camera icon
    var cam = preview.querySelector('.mdi-camera');
    if (cam) cam.style.display = 'none';
  }

  // Switch to form step
  showFormStep();
}

function aiRetry() {
  if (_aiLastFile) {
    startAiAnalysis(_aiLastFile);
  }
}

function aiChangePhoto() {
  // Reset to upload state
  document.getElementById('aiUploadArea').style.display = '';
  document.getElementById('aiPreviewWrap').style.display = 'none';
  document.getElementById('aiLoading').style.display = 'none';
  document.getElementById('aiError').style.display = 'none';
  var aiFileInput = document.querySelector('#aiStep input[type=file]');
  if (aiFileInput) aiFileInput.value = '';
  _aiLastFile = null;
}

// ── Dirty-tracking for wineModal ──────────────────────────────────────────────
var wineFormSnapshot = '';

function getWineFormState() {
  var fields = ['wine_name','wine_year','wine_qty','wine_type','wine_region',
                'wine_notes','wine_purchased_at','wine_price','wine_drink_from',
                'wine_drink_until','wine_location','wine_grape'];
  var parts = fields.map(function(id) { return document.getElementById(id).value; });
  // Stars
  for (var i = 1; i <= 5; i++) {
    var el = document.getElementById('wine_star' + i);
    if (el && el.checked) { parts.push('star' + i); break; }
  }
  // File input
  var fi = document.querySelector('#winePreview input[type=file]');
  if (fi && fi.value) parts.push('file:' + fi.value);
  return parts.join('|');
}

function isWineFormDirty() {
  return getWineFormState() !== wineFormSnapshot;
}

function tryCloseWineModal() {
  if (isWineFormDirty()) {
    if (!confirm(T.confirm_discard)) return;
  }
  closeModal('wineModal');
}

// Helper: get wine data from closest .card element
function getCardData(el) {
  const card = el.closest('.card');
  const d = card.dataset;
  return { id: d.id, wine: {
    name: d.name, year: d.year ? parseInt(d.year) : null,
    type: d.type || null, region: d.region || null,
    quantity: parseInt(d.quantity) || 0, rating: parseInt(d.rating) || 0,
    notes: d.notes || '', image: d.image || null,
    purchased_at: d.purchased_at || null, price: d.price ? parseFloat(d.price) : null,
    drink_from: d.drink_from ? parseInt(d.drink_from) : null,
    drink_until: d.drink_until ? parseInt(d.drink_until) : null,
    location: d.location || null,
    grape: d.grape || null,
    vivino_id: d.vivino_id ? parseInt(d.vivino_id) : null
  }};
}

function cardImgClick(el) {
  const card = el.closest('.card');
  const img = card.dataset.image;
  if (img) {
    openLightbox(INGRESS + '/uploads/' + img);
  } else {
    editFromCard(el);
  }
}

function openLightbox(src) {
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
  document.getElementById('lightboxImg').src = '';
}

function editFromCard(el) {
  const { id, wine } = getCardData(el);
  openWineModal(id, wine);
}

function dupFromCard(el) {
  const { id, wine } = getCardData(el);
  openDupModal(id, wine.name, wine.year, wine.quantity);
}

function deleteFromCard(el) {
  const { id, wine } = getCardData(el);
  document.getElementById('deleteWineName').textContent = wine.name;
  document.getElementById('deleteForm').dataset.wineId = id;
  openModal('deleteModal');
}

function populateFormMerge(fields, imageFilename) {
  // Only fill empty fields — never overwrite existing values
  var filled = 0;
  function setIfEmpty(elId, val) {
    if (!val) return;
    var el = document.getElementById(elId);
    if (el && !el.value.trim()) { el.value = val; filled++; }
  }
  setIfEmpty('wine_name', fields.name);
  setIfEmpty('wine_year', fields.vintage);
  setIfEmpty('wine_type', fields.wine_type);
  setIfEmpty('wine_region', fields.region);
  setIfEmpty('wine_grape', fields.grape);
  setIfEmpty('wine_price', fields.price);
  setIfEmpty('wine_drink_from', fields.drink_from);
  setIfEmpty('wine_drink_until', fields.drink_until);
  setIfEmpty('wine_notes', fields.notes);

  // Set star rating only if none is selected
  if (fields.rating) {
    var anyChecked = false;
    for (var i = 1; i <= 5; i++) {
      if (document.getElementById('wine_star' + i) && document.getElementById('wine_star' + i).checked) anyChecked = true;
    }
    if (!anyChecked) {
      var starVal = Math.round(Number(fields.rating));
      if (starVal >= 1 && starVal <= 5) {
        var starEl = document.getElementById('wine_star' + starVal);
        if (starEl) { starEl.checked = true; filled++; }
      }
    }
  }

  // Set image if no image exists
  if (imageFilename) {
    var existingImg = document.getElementById('aiImageField').value;
    var preview = document.getElementById('winePreview');
    var previewImg = preview ? preview.querySelector('img') : null;
    if (!existingImg && !previewImg) {
      document.getElementById('aiImageField').value = imageFilename;
      if (preview) {
        var img = document.createElement('img');
        img.src = INGRESS + '/uploads/' + imageFilename;
        preview.prepend(img);
        var cam = preview.querySelector('.mdi-camera');
        if (cam) cam.style.display = 'none';
      }
      filled++;
    }
  }

  showFormStep();

  // Show feedback toast
  var msg = filled > 0 ? T.reload_filled : T.reload_nothing;
  showReloadToast(msg, filled > 0);
}

function showReloadToast(msg, success) {
  var toast = document.getElementById('reloadToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'reloadToast';
    toast.className = 'reload-toast';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.className = 'reload-toast ' + (success ? 'success' : 'neutral');
  toast.style.display = 'block';
  toast.style.opacity = '1';
  setTimeout(function() {
    toast.style.opacity = '0';
    setTimeout(function() { toast.style.display = 'none'; }, 400);
  }, 2500);
}

// ── Reload Popover ────────────────────────────────────────────────────────────

function toggleReloadPopover() {
  var pop = document.getElementById('reloadPopover');
  if (pop) pop.style.display = pop.style.display === 'none' ? '' : 'none';
}
function closeReloadPopover() {
  var pop = document.getElementById('reloadPopover');
  if (pop) pop.style.display = 'none';
}
// Close popover on outside click
document.addEventListener('click', function(e) {
  var wrap = document.getElementById('reloadPopoverWrap');
  if (wrap && !wrap.contains(e.target)) closeReloadPopover();
});

function setReloadLoading(on) {
  var btn = document.getElementById('reloadTriggerBtn');
  if (!btn) return;
  var icon = btn.querySelector('.mdi');
  if (on) {
    btn.disabled = true;
    btn.classList.add('loading');
    if (icon) { icon.className = 'mdi mdi-loading mdi-spin'; }
  } else {
    btn.disabled = false;
    btn.classList.remove('loading');
    if (icon) { icon.className = 'mdi mdi-refresh'; }
  }
}

function reloadViaAi() {
  // Collect image filename if available
  var imageFilename = document.getElementById('aiImageField').value;
  if (!imageFilename) {
    var preview = document.getElementById('winePreview');
    var img = preview ? preview.querySelector('img') : null;
    if (img && img.src) {
      var parts = img.src.split('/uploads/');
      if (parts.length > 1) imageFilename = parts[1];
    }
  }

  // Collect known fields as text context
  var context = {};
  var v;
  v = document.getElementById('wine_name').value.trim();    if (v) context.name = v;
  v = document.getElementById('wine_year').value.trim();    if (v) context.year = v;
  v = document.getElementById('wine_type').value;           if (v) context.type = v;
  v = document.getElementById('wine_region').value.trim();  if (v) context.region = v;
  v = document.getElementById('wine_grape').value.trim();   if (v) context.grape = v;

  // Need at least image or text context
  if (!imageFilename && Object.keys(context).length === 0) {
    showReloadToast(T.ai_no_data || 'Kein Bild und kein Weinname vorhanden', false);
    return;
  }

  // Show loading on trigger button
  setReloadLoading(true);

  fetch(INGRESS + '/api/reanalyze-wine', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      image_filename: imageFilename || null,
      wine_context: context
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    setReloadLoading(false);
    if (data.ok && data.fields) {
      populateFormMerge(data.fields, null);
    } else {
      showReloadToast(T.ai_error, false);
    }
  })
  .catch(function() {
    setReloadLoading(false);
    showReloadToast(T.ai_error, false);
  });
}

function reloadViaVivino() {
  // Search Vivino with the wine name, then merge results
  var wineName = document.getElementById('wine_name').value.trim();
  var wineYear = document.getElementById('wine_year').value.trim();
  var query = wineName + (wineYear ? ' ' + wineYear : '');
  if (!query) {
    _reloadMode = true;
    showVivinoPanel();
    return;
  }

  // Show loading on trigger button
  setReloadLoading(true);

  fetch(INGRESS + '/api/vivino-search?q=' + encodeURIComponent(query))
  .then(function(r) { return r.json(); })
  .then(function(data) {
    setReloadLoading(false);
    if (data.ok && data.results && data.results.length > 0) {
      // Use the first result (best match)
      var item = data.results[0];
      var fields = {};
      if (item.name) fields.name = item.name;
      if (item.year) fields.vintage = item.year;
      if (item.wine_type) fields.wine_type = item.wine_type;
      if (item.region) fields.region = item.region;
      if (item.grape) fields.grape = item.grape;
      if (item.price) fields.price = item.price;
      if (item.rating) fields.rating = item.rating;

      // Set vivino_id if empty
      var vivinoField = document.getElementById('wine_vivino_id');
      if (vivinoField && !vivinoField.value && item.vivino_id) {
        vivinoField.value = item.vivino_id;
      }

      // Download image only if the wine has no image at all
      var hasImage = document.getElementById('aiImageField').value
        || document.querySelector('#winePreview img');
      if (!hasImage && item.image_url) {
        downloadVivinoImage(item.image_url);
      }

      populateFormMerge(fields, null);
    } else {
      showReloadToast(T.vivino_no_results, false);
    }
  })
  .catch(function() {
    setReloadLoading(false);
    showReloadToast(T.vivino_error, false);
  });
}

function openDupModal(id, name, year, qty) {
  document.getElementById('dupForm').dataset.wineId = id;
  document.getElementById('dupHint').textContent =
    T.dup_template + ': ' + name + (year ? ' · ' + year : '');
  document.getElementById('dup_year').value = year || '';
  document.getElementById('dup_qty').value = qty || 1;
  openModal('dupModal');
}

// ── AJAX helpers ──────────────────────────────────────────────────────────────

function updateStats(s) {
  // Stats pill was removed in v1.0.0 — kept as no-op for API compatibility
}

function highlightCard(card) {
  card.classList.remove('highlight');
  void card.offsetWidth; // force reflow
  card.classList.add('highlight');
  setTimeout(function() {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

// ── Update location datalist with new locations from cards ─────────────────
function refreshLocationList() {
  var dl = document.getElementById('locationList');
  if (!dl) return;
  var locs = new Set();
  document.querySelectorAll('.card').forEach(function(c) {
    var loc = (c.dataset.location || '').trim();
    if (loc) locs.add(loc);
  });
  var sorted = Array.from(locs).sort(function(a, b) { return a.localeCompare(b); });
  dl.innerHTML = sorted.map(function(l) { return '<option value="' + l.replace(/"/g, '&quot;') + '">'; }).join('');
}

function refreshPurchasedAtList() {
  var dl = document.getElementById('purchasedAtList');
  if (!dl) return;
  var vals = new Set();
  document.querySelectorAll('.card').forEach(function(c) {
    var v = (c.dataset.purchased_at || '').trim();
    if (v) vals.add(v);
  });
  var sorted = Array.from(vals).sort(function(a, b) { return a.localeCompare(b); });
  dl.innerHTML = sorted.map(function(v) { return '<option value="' + v.replace(/"/g, '&quot;') + '">'; }).join('');
}

function refreshRegionList() {
  var dl = document.getElementById('regionList');
  if (!dl) return;
  var vals = new Set();
  document.querySelectorAll('.card').forEach(function(c) {
    var v = (c.dataset.region || '').trim();
    if (v) vals.add(v);
  });
  var sorted = Array.from(vals).sort(function(a, b) { return a.localeCompare(b); });
  dl.innerHTML = sorted.map(function(v) { return '<option value="' + v.replace(/"/g, '&quot;') + '">'; }).join('');
}

function wineIcon(type) {
  if (type === 'Schaumwein') return '<i class="mdi mdi-glass-flute"></i>';
  return '<i class="mdi mdi-glass-wine"></i>';
}

function renderCard(w) {
  var stars = '';
  if (w.rating) {
    stars = '<div class="stars">' + '<i class="mdi mdi-star"></i>'.repeat(w.rating) + '<i class="mdi mdi-star-outline"></i>'.repeat(5 - w.rating) + '</div>';
  }
  var extra = '';
  if (w.price) extra += '<span class="price">' + CURRENCY + ' ' + Number(w.price).toFixed(2) + '</span>';
  if (w.drink_from || w.drink_until) extra += '<span class="drink-window"><i class="mdi mdi-calendar-range"></i> ' + (w.drink_from || '?') + '–' + (w.drink_until || '?') + '</span>';
  if (w.grape) extra += '<span><i class="mdi mdi-fruit-grapes"></i> ' + w.grape + '</span>';
  if (w.location) extra += '<span><i class="mdi mdi-map-marker"></i> ' + w.location + '</span>';
  if (w.vivino_id) extra += '<a class="card-vivino-link" href="https://www.vivino.com/w/' + w.vivino_id + '" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="Vivino"><i class="mdi mdi-open-in-new"></i> Vivino</a>';

  var imgHtml = w.image
    ? '<img src="' + INGRESS + '/uploads/' + w.image + '" alt="' + (w.name||'') + '" loading="lazy">'
    : wineIcon(w.type);

  var notesHtml = w.notes ? '<div class="card-notes">' + w.notes.replace(/</g,'&lt;') + '</div>' : '';

  var metaParts = '';
  if (w.year) metaParts += '<span>' + w.year + '</span>';
  if (w.region) metaParts += '<span>' + w.region + '</span>';

  // Ribbon
  var ribbonHtml = '';
  if (w.quantity == 0) {
    ribbonHtml = '<div class="ribbon ribbon-empty">' + (T.ribbon_empty || '') + '</div>';
  } else if (w.type) {
    var ribbonCls = w.type.toLowerCase().replace(/é/g,'e').replace(/ö/g,'oe');
    ribbonHtml = '<div class="ribbon ribbon-' + ribbonCls + '">' + (T['wine_type_' + w.type] || w.type) + '</div>';
  }

  return ribbonHtml +
    '<div class="card-img" onclick="cardImgClick(this)">' + imgHtml + '</div>' +
    '<div class="qty-badge ' + (w.quantity > 0 ? 'has' : '') + '">' + w.quantity + ' ' + T.bottles_abbr + '</div>' +
    '<div class="card-body" onclick="editFromCard(this)">' +
      '<div class="card-name" title="' + (w.name||'') + '">' + (w.name||'') + '</div>' +
      '<div class="card-meta">' + metaParts + '</div>' +
      stars +
      '<div class="card-extra">' + extra + '</div>' +
      notesHtml +
    '</div>' +
    '<div class="card-actions">' +
      '<button onclick="changeQty(this,-1)" title="' + T.btn_less + '" style="padding:.5rem .65rem">−</button>' +
      '<span class="qty-display" style="flex:1;display:flex;align-items:center;justify-content:center;font-size:.85rem;color:var(--gold);font-weight:700;">' + w.quantity + '</span>' +
      '<button onclick="changeQty(this,1)" title="' + T.btn_more + '" style="padding:.5rem .65rem">+</button>' +
      '<button onclick="editFromCard(this)" title="' + T.btn_edit + '" style="border-left:1px solid var(--border)"><i class="mdi mdi-pencil"></i></button>' +
      '<button onclick="dupFromCard(this)" title="' + T.btn_duplicate + '"><i class="mdi mdi-content-copy"></i></button>' +
      '<button class="danger" title="' + T.btn_delete + '" onclick="deleteFromCard(this)"><i class="mdi mdi-delete"></i></button>' +
    '</div>';
}

function updateCardData(card, w) {
  card.dataset.name = w.name || '';
  card.dataset.year = w.year || '';
  card.dataset.type = w.type || '';
  card.dataset.region = w.region || '';
  card.dataset.quantity = w.quantity;
  card.dataset.rating = w.rating || 0;
  card.dataset.notes = w.notes || '';
  card.dataset.image = w.image || '';
  card.dataset.purchased_at = w.purchased_at || '';
  card.dataset.price = w.price || '';
  card.dataset.drink_from = w.drink_from || '';
  card.dataset.drink_until = w.drink_until || '';
  card.dataset.location = w.location || '';
  card.dataset.grape = w.grape || '';
  card.dataset.vivino_id = w.vivino_id || '';
  card.classList.toggle('empty', w.quantity == 0);
}

function sortGrid() {
  var grid = document.querySelector('.grid');
  var cards = Array.from(grid.querySelectorAll('.card'));
  cards.sort(function(a, b) {
    var t = (a.dataset.type || '').localeCompare(b.dataset.type || '');
    if (t !== 0) return t;
    var n = (a.dataset.name || '').localeCompare(b.dataset.name || '');
    if (n !== 0) return n;
    return (parseInt(a.dataset.year) || 0) - (parseInt(b.dataset.year) || 0);
  });
  cards.forEach(function(c) { grid.appendChild(c); });
}

// ── AJAX form submit (wineModal) ──────────────────────────────────────────────

document.getElementById('wineForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var form = this;
  var fd = new FormData(form);
  fetch(form.action, {
    method: 'POST', body: fd,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (!data.ok) return;
    var w = data.wine;
    var card = document.querySelector('.card[data-id="' + w.id + '"]');
    if (card) {
      // Edit: update existing card
      updateCardData(card, w);
      card.innerHTML = renderCard(w);
    } else {
      // Add: create new card
      card = document.createElement('div');
      card.className = 'card' + (w.quantity == 0 ? ' empty' : '');
      card.dataset.id = w.id;
      updateCardData(card, w);
      card.innerHTML = renderCard(w);
      var grid = document.querySelector('.grid');
      // Remove empty state if present
      var emptyState = grid.querySelector('.empty-state');
      if (emptyState) emptyState.remove();
      grid.appendChild(card);
    }
    ensureFilterTab(w.type);
    updateStats(data.stats);
    refreshLocationList();
    refreshPurchasedAtList();
    refreshRegionList();
    closeModal('wineModal');
    applyFilters();
    sortGrid();
    highlightCard(card);
  });
});

// ── AJAX qty change ───────────────────────────────────────────────────────────

function changeQty(el, delta) {
  var card = el.closest('.card');
  var id = card.dataset.id;
  var d = card.dataset;
  var newQty = Math.max(0, (parseInt(d.quantity) || 0) + delta);

  var fd = new FormData();
  fd.append('name', d.name);
  fd.append('year', d.year);
  fd.append('type', d.type);
  fd.append('region', d.region);
  fd.append('quantity', newQty);
  fd.append('rating', d.rating);
  fd.append('notes', d.notes);
  fd.append('purchased_at', d.purchased_at);
  fd.append('price', d.price);
  fd.append('drink_from', d.drink_from);
  fd.append('drink_until', d.drink_until);
  fd.append('location', d.location);
  fd.append('grape', d.grape);
  fd.append('vivino_id', d.vivino_id || '');

  // Optimistic UI update
  card.dataset.quantity = newQty;
  card.querySelector('.qty-display').textContent = newQty;
  card.querySelector('.qty-badge').textContent = newQty + ' ' + T.bottles_abbr;
  card.querySelector('.qty-badge').classList.toggle('has', newQty > 0);
  card.classList.toggle('empty', newQty == 0);
  applyFilters();

  fetch(INGRESS + '/edit/' + id, {
    method: 'POST', body: fd,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) { if (data.ok) updateStats(data.stats); });
}

// ── AJAX duplicate ────────────────────────────────────────────────────────────

document.getElementById('dupForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var form = this;
  var id = form.dataset.wineId;
  var fd = new FormData(form);

  fetch(INGRESS + '/duplicate/' + id, {
    method: 'POST', body: fd,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (!data.ok) return;
    var w = data.wine;
    var card = document.createElement('div');
    card.className = 'card' + (w.quantity == 0 ? ' empty' : '');
    card.dataset.id = w.id;
    updateCardData(card, w);
    card.innerHTML = renderCard(w);
    // Insert after original card
    var orig = document.querySelector('.card[data-id="' + id + '"]');
    if (orig && orig.nextSibling) {
      orig.parentNode.insertBefore(card, orig.nextSibling);
    } else {
      document.querySelector('.grid').appendChild(card);
    }
    ensureFilterTab(w.type);
    updateStats(data.stats);
    refreshLocationList();
    refreshPurchasedAtList();
    refreshRegionList();
    closeModal('dupModal');
    applyFilters();
    sortGrid();
    highlightCard(card);
  });
});

// ── AJAX delete ───────────────────────────────────────────────────────────────

document.getElementById('deleteForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var form = this;
  var id = form.dataset.wineId;

  fetch(INGRESS + '/delete/' + id, {
    method: 'POST',
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (!data.ok) return;
    var card = document.querySelector('.card[data-id="' + id + '"]');
    if (card) card.remove();
    updateStats(data.stats);
    refreshLocationList();
    refreshPurchasedAtList();
    refreshRegionList();
    closeModal('deleteModal');
    // Show empty state if no cards left
    var grid = document.querySelector('.grid');
    if (!grid.querySelector('.card')) {
      grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div><i class="mdi mdi-glass-wine" style="font-size:4rem"></i></div><p>' + T.empty_no_wines + '<br>' + T.empty_add_first + '</p></div>';
    }
  });
});

// Highlight newly added wine & scroll to it (for non-JS fallback / initial load)
(function() {
  const params = new URLSearchParams(window.location.search);
  const newId = params.get('new');
  if (!newId) return;
  const card = document.querySelector('.card[data-id="' + newId + '"]');
  if (!card) return;
  highlightCard(card);
  params.delete('new');
  const clean = params.toString();
  history.replaceState(null, '', window.location.pathname + (clean ? '?' + clean : ''));
})();

// Apply filters on initial load (hides empty bottles when showEmpty is false)
applyFilters();
</script>

<button class="fab" onclick="openWineModal()" title="{{ t.btn_add_wine }}"><i class="mdi mdi-plus"></i></button>

</body>
</html>
