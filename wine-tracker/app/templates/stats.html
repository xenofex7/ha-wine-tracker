<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Statistiken ‚Äì Wine Tracker</title>
<style>
  :root {
    --bg: #1a0a0f;
    --surface: #2a1520;
    --surface2: #3a1f2c;
    --border: #5a2a3a;
    --accent: #c0392b;
    --accent2: #8b1a2a;
    --gold: #d4a843;
    --text: #f0e0e5;
    --muted: #9a7a82;
    --empty: #3a2a30;
    --radius: 12px;
    --shadow: 0 4px 24px rgba(0,0,0,.5);
  }
  html.light {
    --bg: #f5f0eb;
    --surface: #ffffff;
    --surface2: #f0e8e0;
    --border: #ddd0c8;
    --accent: #a03025;
    --accent2: #7a1520;
    --gold: #9a7a20;
    --text: #2a1a10;
    --muted: #7a6a60;
    --empty: #ece5de;
    --shadow: 0 4px 24px rgba(0,0,0,.1);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
         background: var(--bg); color: var(--text); min-height: 100vh; }

  /* Header */
  header {
    background: linear-gradient(135deg, var(--accent2), var(--surface));
    padding: 1.2rem 1.5rem;
    display: flex; align-items: center; gap: 1rem;
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 100;
    box-shadow: var(--shadow);
  }
  .back-btn {
    background: none; border: 1px solid var(--border); color: var(--muted);
    height: 32px; padding: 0 .7rem; border-radius: 8px; cursor: pointer;
    font-size: .85rem; display: flex; align-items: center; gap: .3rem;
    text-decoration: none; transition: all .2s; flex-shrink: 0;
  }
  .back-btn:hover { color: var(--text); border-color: var(--text); }
  header h1 { font-size: 1.3rem; font-weight: 700; flex: 1; }
  .theme-toggle {
    background: none; border: 1px solid var(--border); color: var(--muted);
    height: 32px; border-radius: 16px; cursor: pointer;
    font-size: .85rem; display: flex; align-items: center; justify-content: center;
    transition: all .2s; flex-shrink: 0; padding: 0 .6rem;
  }
  .theme-toggle:hover { color: var(--text); border-color: var(--text); }

  /* Content */
  .content { max-width: 900px; margin: 0 auto; padding: 1.5rem; }

  /* Highlight cards (top row) */
  .highlights {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem; margin-bottom: 1.5rem;
  }
  .highlight-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 1.2rem 1rem;
    text-align: center;
  }
  .highlight-card .emoji { font-size: 1.8rem; margin-bottom: .4rem; }
  .highlight-card .big-number {
    font-size: 2rem; font-weight: 800; color: var(--gold);
    line-height: 1.1;
  }
  .highlight-card .label {
    font-size: .8rem; color: var(--muted); margin-top: .25rem;
  }

  /* Stat sections */
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.25rem; margin-bottom: 1.5rem;
  }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
  }
  .stat-card h2 {
    padding: .85rem 1rem; font-size: .9rem; font-weight: 700;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: .5rem;
    color: var(--text);
  }
  .stat-card .stat-body { padding: 1rem; }

  /* Donut chart */
  .donut-card .stat-body { padding: 1.2rem 1.5rem; }
  .donut-wrap {
    display: flex; align-items: center;
    gap: 2rem;
  }
  .donut-svg-wrap {
    position: relative; width: 150px; height: 150px; flex-shrink: 0;
  }
  .donut-svg-wrap svg { width: 100%; height: 100%; transform: rotate(-90deg); }
  .donut-center {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    pointer-events: none;
  }
  .donut-center .big { font-size: 2rem; font-weight: 800; color: var(--text); line-height: 1; }
  .donut-center .sub {
    font-size: .6rem; color: var(--muted); margin-top: .2rem;
    text-transform: uppercase; letter-spacing: .1em; font-weight: 600;
  }
  .donut-legend { display: flex; flex-direction: column; gap: .7rem; flex: 1; min-width: 0; }
  .donut-legend-item {
    display: flex; align-items: center; gap: .6rem;
    font-size: .9rem;
  }
  .donut-dot {
    width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
  }
  .donut-legend-label {
    flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .donut-legend-value {
    font-weight: 700; color: var(--text); font-size: .95rem; flex-shrink: 0;
    min-width: 40px; text-align: right;
  }
  @media (max-width: 420px) {
    .donut-wrap { flex-direction: column; align-items: center; gap: 1rem; }
    .donut-legend { width: 100%; }
  }

  /* Bar chart (CSS-only) */
  .bar-list { display: flex; flex-direction: column; gap: .65rem; }
  .bar-item { display: flex; align-items: center; gap: .75rem; }
  .bar-label {
    font-size: .82rem; width: 90px; flex-shrink: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .bar-track {
    flex: 1; height: 22px; background: var(--bg);
    border-radius: 6px; overflow: hidden; position: relative;
  }
  .bar-fill {
    height: 100%; border-radius: 6px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width .6s ease;
    min-width: 2px;
  }
  .bar-value {
    font-size: .78rem; color: var(--gold); font-weight: 700;
    width: 50px; text-align: right; flex-shrink: 0;
  }

  /* Wine list */
  .wine-list { display: flex; flex-direction: column; gap: .6rem; }
  .wine-list-item {
    display: flex; align-items: center; gap: .75rem;
    padding: .5rem .6rem; background: var(--bg);
    border-radius: 8px;
  }
  .wine-list-item .rank {
    font-size: .75rem; font-weight: 800; color: var(--accent);
    width: 20px; text-align: center; flex-shrink: 0;
  }
  .wine-list-item .wine-info { flex: 1; min-width: 0; }
  .wine-list-item .wine-name {
    font-size: .85rem; font-weight: 600;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .wine-list-item .wine-detail {
    font-size: .75rem; color: var(--muted);
  }
  .wine-list-item .stars { color: var(--gold); font-size: .85rem; flex-shrink: 0; }
  .wine-list-item .wine-price { color: var(--gold); font-size: .85rem; font-weight: 700; flex-shrink: 0; }

  /* Info row */
  .info-row {
    display: flex; gap: .6rem; flex-wrap: wrap; margin-bottom: 1.5rem;
  }
  .info-chip {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: .45rem .9rem;
    font-size: .82rem; display: flex; align-items: center; gap: .4rem;
  }
  .info-chip .chip-label { color: var(--muted); }
  .info-chip .chip-value { font-weight: 700; }

  /* Map */
  .map-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
    margin-bottom: 1.5rem;
  }
  .map-card h2 {
    padding: .85rem 1rem; font-size: .9rem; font-weight: 700;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: .5rem;
    color: var(--text);
  }
  .globe-wrap {
    position: relative;
    display: flex; justify-content: center; align-items: center;
    padding: 1rem 0;
    background: var(--bg);
  }
  #globeCanvas {
    width: 100%; max-width: 500px;
    aspect-ratio: 1 / 1;
    cursor: grab;
  }
  #globeCanvas:active { cursor: grabbing; }
  .globe-legend {
    position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);
    display: flex; flex-direction: column; gap: .35rem;
    padding: .6rem .8rem; border-radius: 10px;
    background: rgba(0,0,0,.45); backdrop-filter: blur(6px);
    max-height: 80%; overflow-y: auto;
    pointer-events: none;
  }
  .light .globe-legend { background: rgba(255,255,255,.55); }
  .globe-legend-item {
    display: flex; align-items: center; gap: .45rem;
    font-size: .7rem; color: #fff; white-space: nowrap;
  }
  .light .globe-legend-item { color: var(--text); }
  .globe-legend-dot {
    width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
    background: var(--wine);
  }
  .globe-legend-qty {
    margin-left: auto; font-weight: 700; padding-left: .5rem;
    opacity: .8;
  }
  @media (max-width: 500px) {
    #globeCanvas { max-width: 280px; }
    .globe-legend { position: static; transform: none; width: 100%; max-height: none; margin-top: .5rem; }
  }

  /* Empty state */
  .empty-stats {
    text-align: center; padding: 4rem 2rem; color: var(--muted);
  }
  .empty-stats div { font-size: 4rem; margin-bottom: 1rem; }
</style>
</head>
<body>

<header>
  <a class="back-btn" href="{{ ingress }}/">‚Üê Zur√ºck</a>
  <h1>üìä Statistiken</h1>
  <button class="theme-toggle" onclick="cycleTheme()" title="Darstellung wechseln"><span class="theme-icon">‚òÄÔ∏è</span></button>
</header>

<div class="content">

{% set total_bottles = totals['bottles'] or 0 %}
{% set total_wines = totals['wines'] or 0 %}

{% if total_wines == 0 %}
  <div class="empty-stats">
    <div>üìä</div>
    <p>Noch keine Daten vorhanden.<br>F√ºge zuerst Weine hinzu!</p>
  </div>
{% else %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HIGHLIGHT CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="highlights">
  <div class="highlight-card">
    <div class="emoji">üçæ</div>
    <div class="big-number">{{ total_bottles }}</div>
    <div class="label">{{ 'Flasche' if total_bottles == 1 else 'Flaschen' }} gesamt</div>
  </div>

  <div class="highlight-card">
    <div class="emoji">üì¶</div>
    <div class="big-number">{{ total_wines }}</div>
    <div class="label">{{ 'Wein' if total_wines == 1 else 'Verschiedene Weine' }}</div>
  </div>

  {% if value and value['total_value'] %}
  <div class="highlight-card">
    <div class="emoji">üí∞</div>
    <div class="big-number">{{ "%.0f"|format(value['total_value']) }}</div>
    <div class="label">{{ currency }} Gesamtwert</div>
  </div>
  {% endif %}

  {% if avg_age is not none and avg_age %}
  <div class="highlight-card">
    <div class="emoji">‚è≥</div>
    <div class="big-number">~{{ "%.0f"|format(avg_age) }}</div>
    <div class="label">Jahre √ò Alter</div>
  </div>
  {% endif %}
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INFO CHIPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="info-row">
  <div class="info-chip">
    <span class="chip-label">Auf Lager:</span>
    <span class="chip-value">{{ in_stock }} Fl.</span>
  </div>
  <div class="info-chip">
    <span class="chip-label">Ausgetrunken:</span>
    <span class="chip-value">{{ out_of_stock }} {{ 'Wein' if out_of_stock == 1 else 'Weine' }}</span>
  </div>
  {% if value and value['avg_price'] %}
  <div class="info-chip">
    <span class="chip-label">√ò Preis:</span>
    <span class="chip-value">{{ currency }} {{ "%.2f"|format(value['avg_price']) }}</span>
  </div>
  {% endif %}
  {% if oldest %}
  <div class="info-chip">
    <span>üèõ</span>
    <span class="chip-label">√Ñltester:</span>
    <span class="chip-value">{{ oldest['name'] }} {{ oldest['year'] }}</span>
  </div>
  {% endif %}
  {% if newest %}
  <div class="info-chip">
    <span>‚ú®</span>
    <span class="chip-label">Neuester:</span>
    <span class="chip-value">{{ newest['name'] }} {{ newest['year'] }}</span>
  </div>
  {% endif %}
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HERKUNFT MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if map_points %}
<div class="map-card">
  <h2>üåç Herkunft deiner Weine</h2>
  <div class="globe-wrap">
    <canvas id="globeCanvas"></canvas>
    <div class="globe-legend">
      {% for p in map_points|sort(attribute='qty', reverse=True) %}
      <div class="globe-legend-item">
        <span class="globe-legend-dot"></span>
        <span>{{ p.region }}</span>
        <span class="globe-legend-qty">{{ p.qty }}</span>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BAR CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="stat-grid">

  {% if by_type %}
  {% set type_total = by_type|sum(attribute='qty') %}
  <div class="stat-card donut-card">
    <h2>üç∑ Flaschen pro Typ</h2>
    <div class="stat-body">
      <div class="donut-wrap">
        <div class="donut-svg-wrap">
          <svg viewBox="0 0 100 100">
            {# Donut segments via stroke-dasharray on circles #}
            {% set ns = namespace(offset=0) %}
            {% set colors = ['#c0392b', '#d4a843', '#8b1a2a', '#e67e22', '#6c3461', '#2c8c99'] %}
            {% for item in by_type %}
            {% set pct = (item['qty'] / type_total * 100) if type_total > 0 else 0 %}
            {% set gap = 1.2 %}
            {% set seg = pct - gap if pct > gap else pct %}
            <circle cx="50" cy="50" r="35"
                    fill="none" stroke="{{ colors[loop.index0 % 6] }}"
                    stroke-width="12"
                    stroke-dasharray="{{ seg * 2.199 }} {{ 219.9 - seg * 2.199 }}"
                    stroke-dashoffset="{{ -ns.offset * 2.199 }}"
                    style="opacity:.92; transition: stroke-dasharray .6s ease;"/>
            {% set ns.offset = ns.offset + pct %}
            {% endfor %}
          </svg>
          <div class="donut-center">
            <div class="big">{{ type_total }}</div>
            <div class="sub">Flaschen</div>
          </div>
        </div>
        <div class="donut-legend">
          {% for item in by_type %}
          {% set colors = ['#c0392b', '#d4a843', '#8b1a2a', '#e67e22', '#6c3461', '#2c8c99'] %}
          {% set pct = (item['qty'] / type_total * 100)|round|int if type_total > 0 else 0 %}
          <div class="donut-legend-item">
            <span class="donut-dot" style="background:{{ colors[loop.index0 % 6] }}"></span>
            <span class="donut-legend-label">{{ item['type'] }}</span>
            <span class="donut-legend-value">{{ pct }}%</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if top_regions %}
  <div class="stat-card">
    <h2>üåç Top Regionen</h2>
    <div class="stat-body">
      <div class="bar-list">
        {% set region_total = top_regions|sum(attribute='qty') %}
        {% set max_region = top_regions[0]['qty'] if top_regions else 1 %}
        {% for item in top_regions %}
        <div class="bar-item">
          <div class="bar-label" title="{{ item['region'] }}">{{ item['region'] }}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: {{ (item['qty'] / max_region * 100)|round }}%"></div>
          </div>
          <div class="bar-value">{{ (item['qty'] / region_total * 100)|round }}%</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LISTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="stat-grid">

  {% if best_rated %}
  <div class="stat-card">
    <h2>‚≠ê Beste Bewertungen</h2>
    <div class="stat-body">
      <div class="wine-list">
        {% for w in best_rated %}
        <div class="wine-list-item">
          <div class="rank">{{ loop.index }}</div>
          <div class="wine-info">
            <div class="wine-name">{{ w['name'] }}</div>
            <div class="wine-detail">
              {% if w['year'] %}{{ w['year'] }}{% endif %}
              {% if w['type'] %} ¬∑ {{ w['type'] }}{% endif %}
            </div>
          </div>
          <div class="stars">{{ '‚òÖ' * w['rating'] }}{{ '‚òÜ' * (5 - w['rating']) }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {% if most_expensive or cheapest %}
  <div class="stat-card">
    <h2>üí∂ Preis√ºbersicht</h2>
    <div class="stat-body">
      <div class="wine-list">
        {% if most_expensive %}
        <div class="wine-list-item">
          <div class="rank">üìà</div>
          <div class="wine-info">
            <div class="wine-name">{{ most_expensive['name'] }}</div>
            <div class="wine-detail">Teuerster Wein{% if most_expensive['year'] %} ¬∑ {{ most_expensive['year'] }}{% endif %}</div>
          </div>
          <div class="wine-price">{{ currency }} {{ "%.2f"|format(most_expensive['price']) }}</div>
        </div>
        {% endif %}
        {% if cheapest %}
        <div class="wine-list-item">
          <div class="rank">üìâ</div>
          <div class="wine-info">
            <div class="wine-name">{{ cheapest['name'] }}</div>
            <div class="wine-detail">G√ºnstigster Wein{% if cheapest['year'] %} ¬∑ {{ cheapest['year'] }}{% endif %}</div>
          </div>
          <div class="wine-price">{{ currency }} {{ "%.2f"|format(cheapest['price']) }}</div>
        </div>
        {% endif %}
        {% if value and value['avg_price'] %}
        <div class="wine-list-item">
          <div class="rank">√ò</div>
          <div class="wine-info">
            <div class="wine-name">Durchschnittspreis</div>
            <div class="wine-detail">√úber alle Weine mit Preis</div>
          </div>
          <div class="wine-price">{{ currency }} {{ "%.2f"|format(value['avg_price']) }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if recent %}
<div class="stat-grid">
  <div class="stat-card">
    <h2>üïê Zuletzt hinzugef√ºgt</h2>
    <div class="stat-body">
      <div class="wine-list">
        {% for w in recent %}
        <div class="wine-list-item">
          <div class="rank">{{ loop.index }}</div>
          <div class="wine-info">
            <div class="wine-name">{{ w['name'] }}</div>
            <div class="wine-detail">
              {% if w['type'] %}{{ w['type'] }}{% endif %}
              {% if w['year'] %} ¬∑ {{ w['year'] }}{% endif %}
              {% if w['added'] %} ¬∑ {{ w['added'] }}{% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endif %}
</div>

<script type="module">
// ‚îÄ‚îÄ COBE 3D Globe ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
import createGlobe from 'https://cdn.skypack.dev/cobe';

const GLOBE_THEMES = {
  dark: {
    dark: 1,
    baseColor: [0.3, 0.1, 0.15],
    markerColor: [0.9, 0.35, 0.25],
    glowColor: [0.2, 0.05, 0.1],
    mapBrightness: 6,
    diffuse: 1.2
  },
  light: {
    dark: 0,
    baseColor: [1, 1, 1],
    markerColor: [0.75, 0.15, 0.12],
    glowColor: [0.85, 0.8, 0.75],
    mapBrightness: 8,
    diffuse: 2
  }
};

let globeInstance = null;
let phi = 0;
let theta = 0;
let pointerDown = false;
let pointerX = 0;
let pointerY = 0;
let velocity = 0;
let resumeAutoRotate = 0;

function initGlobe() {
  const canvas = document.getElementById('globeCanvas');
  if (!canvas) return;

  const points = {{ map_points | tojson }};
  if (!points || points.length === 0) {
    canvas.closest('.map-card')?.remove();
    return;
  }

  // Build markers from map_points
  const maxQty = Math.max(...points.map(p => p.qty));
  const markers = points.map(p => ({
    location: [p.lat, p.lon],
    size: Math.max(0.04, (p.qty / maxQty) * 0.14)
  }));

  // Determine initial rotation to center on the first/biggest region
  const biggest = points.reduce((a, b) => a.qty > b.qty ? a : b);
  const startPhi = -((biggest.lon * Math.PI) / 180);
  const startTheta = ((biggest.lat * Math.PI) / 180) * 0.6 + 0.15;
  phi = startPhi;
  theta = startTheta;

  // Get current theme
  const isLight = document.documentElement.classList.contains('light');
  const theme = isLight ? GLOBE_THEMES.light : GLOBE_THEMES.dark;

  // Canvas sizing
  const w = canvas.offsetWidth;
  const dpr = window.devicePixelRatio || 1;

  // Destroy existing globe
  if (globeInstance) { globeInstance.destroy(); globeInstance = null; }

  globeInstance = createGlobe(canvas, {
    devicePixelRatio: Math.min(dpr, 2),
    width: w * 2,
    height: w * 2,
    phi: phi,
    theta: startTheta,
    dark: theme.dark,
    diffuse: theme.diffuse,
    mapSamples: 16000,
    mapBrightness: theme.mapBrightness,
    baseColor: theme.baseColor,
    markerColor: theme.markerColor,
    glowColor: theme.glowColor,
    markers: markers,
    opacity: 0.85,
    onRender: (state) => {
      const now = Date.now();
      if (!pointerDown && now > resumeAutoRotate) {
        phi += 0.003;
      }
      phi += velocity;
      velocity *= 0.92;
      if (Math.abs(velocity) < 0.00001) velocity = 0;
      state.phi = phi;
      state.theta = theta;
      state.width = canvas.offsetWidth * 2;
      state.height = canvas.offsetWidth * 2;
    }
  });

  // Pointer interaction ‚Äì drag to rotate (X = longitude, Y = latitude)
  canvas.addEventListener('pointerdown', (e) => {
    pointerDown = true;
    pointerX = e.clientX;
    pointerY = e.clientY;
    velocity = 0;
    canvas.style.cursor = 'grabbing';
  });
  window.addEventListener('pointerup', () => {
    if (pointerDown) {
      pointerDown = false;
      resumeAutoRotate = Date.now() + 2000;
      canvas.style.cursor = 'grab';
    }
  });
  window.addEventListener('pointermove', (e) => {
    if (pointerDown) {
      const dx = e.clientX - pointerX;
      const dy = e.clientY - pointerY;
      pointerX = e.clientX;
      pointerY = e.clientY;
      phi += dx * 0.005;
      theta = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, theta - dy * 0.005));
    }
  });
}

// ‚îÄ‚îÄ Theme: 3-state cycle (shared with index page) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const THEME_MODES = ['dark', 'light', 'system'];
const THEME_ICONS = { dark: 'üåô', light: '‚òÄÔ∏è', system: 'üíª' };

function getSystemPreference() {
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}

function applyTheme(mode) {
  const effective = mode === 'system' ? getSystemPreference() : mode;
  document.documentElement.classList.toggle('light', effective === 'light');
  const btn = document.querySelector('.theme-icon');
  if (btn) btn.textContent = THEME_ICONS[mode];
  // Recreate globe with theme-matching colors
  initGlobe();
}

window.cycleTheme = function() {
  const current = localStorage.getItem('wine-theme') || 'dark';
  const idx = THEME_MODES.indexOf(current);
  const next = THEME_MODES[(idx + 1) % THEME_MODES.length];
  localStorage.setItem('wine-theme', next);
  applyTheme(next);
};

// Init theme
(function() {
  const saved = localStorage.getItem('wine-theme') || 'dark';
  applyTheme(saved);
  window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
    if (localStorage.getItem('wine-theme') === 'system') applyTheme('system');
  });
})();
</script>

</body>
</html>
