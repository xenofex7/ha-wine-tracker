<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7/css/materialdesignicons.min.css">
<link rel="stylesheet" href="{{ ingress }}/static/style.css">
<title>{{ t.stats_title }} – Wine Tracker</title>
</head>
<body>

<header>
  <a class="back-btn" href="{{ ingress }}/"><i class="mdi mdi-arrow-left"></i> {{ t.back }}</a>
  <h1><i class="mdi mdi-chart-box"></i> {{ t.stats_title }}</h1>
  <button class="theme-toggle" onclick="cycleTheme()" title="{{ t.toggle_theme }}"><span class="theme-icon"><i class="mdi mdi-weather-sunny"></i></span></button>
</header>

<div class="content">

{% set total_bottles = totals['bottles'] or 0 %}
{% set total_wines = totals['wines'] or 0 %}

{% if total_wines == 0 %}
  <div class="empty-state">
    <div><i class="mdi mdi-chart-box"></i></div>
    <p>{{ t.stat_no_data }}<br>{{ t.stat_add_wines_first }}</p>
  </div>
{% else %}

<!-- ═══════ HIGHLIGHT CARDS ═══════ -->
<div class="highlights">
  <div class="highlight-card">
    <div class="emoji"><i class="mdi mdi-bottle-wine"></i></div>
    <div class="big-number">{{ total_bottles }}</div>
    <div class="label">{{ t.stat_bottle if total_bottles == 1 else t.stat_bottles }} {{ t.stat_bottles_total }}</div>
  </div>

  <div class="highlight-card">
    <div class="emoji"><i class="mdi mdi-package-variant"></i></div>
    <div class="big-number">{{ total_wines }}</div>
    <div class="label">{{ t.stat_wine_singular if total_wines == 1 else t.stat_different_wines }}</div>
  </div>

  {% if value and value['total_value'] %}
  <div class="highlight-card">
    <div class="emoji"><i class="mdi mdi-cash-multiple"></i></div>
    <div class="big-number">{{ "%.0f"|format(value['total_value']) }}</div>
    <div class="label">{{ currency }} {{ t.stat_total_value }}</div>
  </div>
  {% endif %}

  {% if avg_age is not none and avg_age %}
  <div class="highlight-card">
    <div class="emoji"><i class="mdi mdi-timer-sand"></i></div>
    <div class="big-number">~{{ "%.0f"|format(avg_age) }}</div>
    <div class="label">{{ t.stat_avg_age_years }}</div>
  </div>
  {% endif %}
</div>


<!-- ═══════ INFO CHIPS ═══════ -->
<div class="info-row">
  <div class="info-chip">
    <span class="chip-label">{{ t.stat_in_stock }}:</span>
    <span class="chip-value">{{ in_stock }} {{ t.bottles_abbr }}</span>
  </div>
  <div class="info-chip">
    <span class="chip-label">{{ t.stat_drunk }}:</span>
    <span class="chip-value">{{ out_of_stock }} {{ t.stat_wine_drunk_singular if out_of_stock == 1 else t.stat_wines_drunk_plural }}</span>
  </div>
  {% if value and value['avg_price'] %}
  <div class="info-chip">
    <span class="chip-label">{{ t.stat_avg_price }}:</span>
    <span class="chip-value">{{ currency }} {{ "%.2f"|format(value['avg_price']) }}</span>
  </div>
  {% endif %}
  {% if oldest %}
  <div class="info-chip">
    <span><i class="mdi mdi-bank"></i></span>
    <span class="chip-label">{{ t.stat_oldest }}:</span>
    <span class="chip-value">{{ oldest['name'] }} {{ oldest['year'] }}</span>
  </div>
  {% endif %}
  {% if newest %}
  <div class="info-chip">
    <span><i class="mdi mdi-shimmer"></i></span>
    <span class="chip-label">{{ t.stat_newest }}:</span>
    <span class="chip-value">{{ newest['name'] }} {{ newest['year'] }}</span>
  </div>
  {% endif %}
</div>


<!-- ═══════ HERKUNFT MAP ═══════ -->
{% if map_points %}
<div class="map-card">
  <h2><i class="mdi mdi-earth"></i> {{ t.stat_wine_origin }}</h2>
  <div class="globe-wrap">
    <canvas id="globeCanvas"></canvas>
    <div class="globe-legend">
      {% for p in map_points|sort(attribute='qty', reverse=True) %}
      <div class="globe-legend-item">
        <span class="globe-legend-dot"></span>
        <span>{{ p.region }}</span>
        <span class="globe-legend-qty">{{ p.qty }}</span>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- ═══════ BAR CHARTS ═══════ -->
<div class="stat-grid">

  {% if by_type %}
  {% set type_total = by_type|sum(attribute='qty') %}
  <div class="stat-card donut-card">
    <h2><i class="mdi mdi-glass-wine"></i> {{ t.stat_bottles_by_type }}</h2>
    <div class="stat-body">
      <div class="donut-wrap">
        <div class="donut-svg-wrap">
          <svg viewBox="0 0 100 100">
            {# Donut segments via stroke-dasharray on circles #}
            {% set ns = namespace(offset=0) %}
            {% set type_colors = {
              'Rotwein': 'var(--wine-rotwein)', 'Weisswein': 'var(--wine-weisswein)',
              'Rosé': 'var(--wine-rose)', 'Schaumwein': 'var(--wine-schaumwein)',
              'Dessertwein': 'var(--wine-dessertwein)', 'Anderes': 'var(--wine-anderes)'
            } %}
            {% for item in by_type %}
            {% set pct = (item['qty'] / type_total * 100) if type_total > 0 else 0 %}
            {% set gap = 1.2 %}
            {% set seg = pct - gap if pct > gap else pct %}
            <circle cx="50" cy="50" r="35"
                    fill="none" stroke="{{ type_colors[item['type']] or 'var(--wine-anderes)' }}"
                    stroke-width="12"
                    stroke-dasharray="{{ seg * 2.199 }} {{ 219.9 - seg * 2.199 }}"
                    stroke-dashoffset="{{ -ns.offset * 2.199 }}"
                    style="opacity:.92; transition: stroke-dasharray .6s ease;"/>
            {% set ns.offset = ns.offset + pct %}
            {% endfor %}
          </svg>
          <div class="donut-center">
            <div class="big">{{ type_total }}</div>
            <div class="sub">{{ t.stat_bottles_label }}</div>
          </div>
        </div>
        <div class="donut-legend">
          {% for item in by_type %}
          {% set pct = (item['qty'] / type_total * 100)|round|int if type_total > 0 else 0 %}
          <div class="donut-legend-item">
            <span class="donut-dot" style="background:{{ type_colors[item['type']] or 'var(--wine-anderes)' }}"></span>
            <span class="donut-legend-label">{{ item['type'] | wine_type }}</span>
            <span class="donut-legend-value">{{ pct }}%</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if top_regions %}
  <div class="stat-card">
    <h2><i class="mdi mdi-earth"></i> {{ t.stat_top_regions }}</h2>
    <div class="stat-body">
      <div class="bar-list">
        {% set region_total = top_regions|sum(attribute='qty') %}
        {% set max_region = top_regions[0]['qty'] if top_regions else 1 %}
        {% for item in top_regions %}
        <div class="bar-item">
          <div class="bar-label" title="{{ item['region'] }}">{{ item['region'] }}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: {{ (item['qty'] / max_region * 100)|round }}%"></div>
          </div>
          <div class="bar-value">{{ (item['qty'] / region_total * 100)|round }}%</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>


<!-- ═══════ LISTS ═══════ -->
<div class="stat-grid">

  {% if best_rated %}
  <div class="stat-card">
    <h2><i class="mdi mdi-star"></i> {{ t.stat_best_rated }}</h2>
    <div class="stat-body">
      <div class="wine-list">
        {% for w in best_rated %}
        <div class="wine-list-item">
          <div class="rank">{{ loop.index }}</div>
          <div class="wine-info">
            <div class="wine-name">{{ w['name'] }}</div>
            <div class="wine-detail">
              {% if w['year'] %}{{ w['year'] }}{% endif %}
              {% if w['type'] %} · {{ w['type'] | wine_type }}{% endif %}
            </div>
          </div>
          <div class="stars">{% for i in range(w['rating']) %}<i class="mdi mdi-star"></i>{% endfor %}{% for i in range(5 - w['rating']) %}<i class="mdi mdi-star-outline"></i>{% endfor %}</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {% if most_expensive or cheapest %}
  <div class="stat-card">
    <h2><i class="mdi mdi-cash"></i> {{ t.stat_price_overview }}</h2>
    <div class="stat-body">
      <div class="wine-list">
        {% if most_expensive %}
        <div class="wine-list-item">
          <div class="rank"><i class="mdi mdi-trending-up"></i></div>
          <div class="wine-info">
            <div class="wine-name">{{ most_expensive['name'] }}</div>
            <div class="wine-detail">{{ t.stat_most_expensive }}{% if most_expensive['year'] %} · {{ most_expensive['year'] }}{% endif %}</div>
          </div>
          <div class="wine-price">{{ currency }} {{ "%.2f"|format(most_expensive['price']) }}</div>
        </div>
        {% endif %}
        {% if cheapest %}
        <div class="wine-list-item">
          <div class="rank"><i class="mdi mdi-trending-down"></i></div>
          <div class="wine-info">
            <div class="wine-name">{{ cheapest['name'] }}</div>
            <div class="wine-detail">{{ t.stat_cheapest }}{% if cheapest['year'] %} · {{ cheapest['year'] }}{% endif %}</div>
          </div>
          <div class="wine-price">{{ currency }} {{ "%.2f"|format(cheapest['price']) }}</div>
        </div>
        {% endif %}
        {% if value and value['avg_price'] %}
        <div class="wine-list-item">
          <div class="rank">Ø</div>
          <div class="wine-info">
            <div class="wine-name">{{ t.stat_avg_price_label }}</div>
            <div class="wine-detail">{{ t.stat_across_all }}</div>
          </div>
          <div class="wine-price">{{ currency }} {{ "%.2f"|format(value['avg_price']) }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

</div>


<!-- ═══════ RECENT ═══════ -->
{% if recent %}
<div class="stat-grid">
  <div class="stat-card">
    <h2><i class="mdi mdi-clock-outline"></i> {{ t.stat_recently_added }}</h2>
    <div class="stat-body">
      <div class="wine-list">
        {% for w in recent %}
        <div class="wine-list-item">
          <div class="rank">{{ loop.index }}</div>
          <div class="wine-info">
            <div class="wine-name">{{ w['name'] }}</div>
            <div class="wine-detail">
              {% if w['type'] %}{{ w['type'] | wine_type }}{% endif %}
              {% if w['year'] %} · {{ w['year'] }}{% endif %}
              {% if w['added'] %} · {{ w['added'] }}{% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endif %}
</div>

<script type="module">
// ── COBE 3D Globe ────────────────────────────────────────────────────────────
import createGlobe from 'https://cdn.skypack.dev/cobe';

const GLOBE_THEMES = {
  dark: {
    dark: 1,
    baseColor: [0.3, 0.1, 0.15],
    markerColor: [0.9, 0.35, 0.25],
    glowColor: [0.2, 0.05, 0.1],
    mapBrightness: 6,
    diffuse: 1.2
  },
  light: {
    dark: 0,
    baseColor: [1, 1, 1],
    markerColor: [0.75, 0.15, 0.12],
    glowColor: [0.85, 0.8, 0.75],
    mapBrightness: 8,
    diffuse: 2
  }
};

let globeInstance = null;
let phi = 0;
let theta = 0;
let pointerDown = false;
let pointerX = 0;
let pointerY = 0;
let velocity = 0;
let resumeAutoRotate = 0;

function initGlobe() {
  const canvas = document.getElementById('globeCanvas');
  if (!canvas) return;

  const points = {{ map_points | tojson }};
  if (!points || points.length === 0) {
    canvas.closest('.map-card')?.remove();
    return;
  }

  // Build markers from map_points
  const maxQty = Math.max(...points.map(p => p.qty));
  const markers = points.map(p => ({
    location: [p.lat, p.lon],
    size: Math.max(0.04, (p.qty / maxQty) * 0.14)
  }));

  // Determine initial rotation to center on the first/biggest region
  const biggest = points.reduce((a, b) => a.qty > b.qty ? a : b);
  const startPhi = -((biggest.lon * Math.PI) / 180);
  const startTheta = (biggest.lat * Math.PI) / 180;
  phi = startPhi;
  theta = startTheta;

  // Get current theme
  const isLight = document.documentElement.classList.contains('light');
  const theme = isLight ? GLOBE_THEMES.light : GLOBE_THEMES.dark;

  // Canvas sizing
  const w = canvas.offsetWidth;
  const dpr = window.devicePixelRatio || 1;

  // Destroy existing globe
  if (globeInstance) { globeInstance.destroy(); globeInstance = null; }

  globeInstance = createGlobe(canvas, {
    devicePixelRatio: Math.min(dpr, 2),
    width: w * 2,
    height: w * 2,
    phi: phi,
    theta: startTheta,
    dark: theme.dark,
    diffuse: theme.diffuse,
    mapSamples: 16000,
    mapBrightness: theme.mapBrightness,
    baseColor: theme.baseColor,
    markerColor: theme.markerColor,
    glowColor: theme.glowColor,
    markers: markers,
    opacity: 0.85,
    onRender: (state) => {
      const now = Date.now();
      if (!pointerDown && now > resumeAutoRotate) {
        phi += 0.003;
      }
      phi += velocity;
      velocity *= 0.96;
      if (Math.abs(velocity) < 0.00001) velocity = 0;
      state.phi = phi;
      state.theta = theta;
      state.width = canvas.offsetWidth * 2;
      state.height = canvas.offsetWidth * 2;
    }
  });

  // Pointer interaction – drag to rotate (X = longitude, Y = latitude)
  canvas.addEventListener('pointerdown', (e) => {
    pointerDown = true;
    pointerX = e.clientX;
    pointerY = e.clientY;
    velocity = 0;
    canvas.style.cursor = 'grabbing';
  });
  window.addEventListener('pointerup', () => {
    if (pointerDown) {
      pointerDown = false;
      resumeAutoRotate = Date.now() + 1000;
      canvas.style.cursor = 'grab';
    }
  });
  window.addEventListener('pointermove', (e) => {
    if (pointerDown) {
      const dx = e.clientX - pointerX;
      const dy = e.clientY - pointerY;
      pointerX = e.clientX;
      pointerY = e.clientY;
      phi += dx * 0.005;
      theta = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, theta + dy * 0.005));
    }
  });
}

// ── Theme: 3-state cycle (shared with index page) ────────────────────────────
const THEME_MODES = ['dark', 'light', 'system'];
const THEME_ICONS = { dark: '<i class="mdi mdi-weather-night"></i>', light: '<i class="mdi mdi-weather-sunny"></i>', system: '<i class="mdi mdi-laptop"></i>' };

function getSystemPreference() {
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}

function applyTheme(mode) {
  const effective = mode === 'system' ? getSystemPreference() : mode;
  document.documentElement.classList.toggle('light', effective === 'light');
  const btn = document.querySelector('.theme-icon');
  if (btn) btn.innerHTML = THEME_ICONS[mode];
  // Recreate globe with theme-matching colors
  initGlobe();
}

window.cycleTheme = function() {
  const current = localStorage.getItem('wine-theme') || 'dark';
  const idx = THEME_MODES.indexOf(current);
  const next = THEME_MODES[(idx + 1) % THEME_MODES.length];
  localStorage.setItem('wine-theme', next);
  applyTheme(next);
};

// Init theme
(function() {
  const saved = localStorage.getItem('wine-theme') || 'dark';
  applyTheme(saved);
  window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
    if (localStorage.getItem('wine-theme') === 'system') applyTheme('system');
  });
})();
</script>

</body>
</html>
